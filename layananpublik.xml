<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html b:css='false' b:layoutsVersion='3' b:responsive='true' b:templateVersion='1.3.0' expr:dir='data:blog.languageDirection' lang='en' xmlns='http://www.w3.org/1999/xhtml' xmlns:b='http://www.google.com/2005/gml/b' xmlns:data='http://www.google.com/2005/gml/data' xmlns:expr='http://www.google.com/2005/gml/expr'>
  <head>
    <meta charset='UTF-8'/>
    <meta content='width=device-width, initial-scale=1.0' name='viewport'/>
    <b:include data='blog' name='all-head-content'/>
    <title><data:blog.pageTitle/></title>
    
    <!-- External Libraries -->
    <script src='https://cdn.tailwindcss.com'/>
    <link crossorigin='anonymous' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css' referrerpolicy='no-referrer' rel='stylesheet' xintegrity='sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=='/>
    <link href='https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap' rel='stylesheet'/>
        <script defer='defer' src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'/>
    <link href='https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css' rel='stylesheet'/>
    <script defer='defer' src='https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js'/>
    

    <!-- Custom CSS for Blogger -->
    <b:skin><![CDATA[
      /* Custom CSS can go here if needed, but the style tag below is sufficient */
    ]]></b:skin>
    <style>
      /* <![CDATA[ */
      body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
      @media (max-width: 767px) { body { padding-bottom: 100px; } }
      .bg-brand-green { background-color: #1a3a3a; }
      .text-brand-green { color: #1a3a3a; }
      :root {
        --fc-border-color: #e5e7eb;
        --fc-daygrid-event-dot-width: 8px;
        --fc-today-bg-color: rgba(220, 252, 231, 0.5);
        --fc-button-bg-color: #1a3a3a;
        --fc-button-active-bg-color: #2a6464;
        --fc-button-hover-bg-color: #2a6464;
      }
      .fc .fc-toolbar-title { font-size: 1.25em; }
      .fc .fc-daygrid-day.fc-day-today { background-color: var(--fc-today-bg-color); }
      .info-swiper.info-grid .swiper-wrapper { display: grid; grid-template-columns: repeat(1, 1fr); gap: 1.5rem; }
      @media (min-width: 768px) { .info-swiper.info-grid .swiper-wrapper { grid-template-columns: repeat(2, 1fr); } }
      .info-swiper { position: relative; padding-bottom: 30px; }
      .swiper-pagination { bottom: 0 !important; }
      .swiper-pagination-bullet { background-color: #d1d5db; opacity: 1; }
      .swiper-pagination-bullet-active { background-color: #1a3a3a !important; }
      .layanan-tabs-swiper .swiper-slide { width: auto !important; }
      .layanan-tab { transition: all 0.3s ease; padding: 6px 16px; border-radius: 99px; white-space: nowrap; font-size: 12px; color: #6b7280; }
      .layanan-tab.active { color: #1a3a3a; font-weight: 700; background-color: #f3f4f6; }
      .toggle-btn { transition: all 0.3s ease-in-out; }
      .toggle-btn.active {
          background-color: white;
          color: #1f2937;
          font-weight: 600;
          box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }
      #notificationModal.visible #notificationModalContent { transform: scale(1); opacity: 1; }
      .section-disabled { opacity: 0.5; pointer-events: none; transition: opacity 0.3s ease-in-out; }
      input:disabled, select:disabled, textarea:disabled { background-color: #f3f4f6; cursor: not-allowed; }
      @media (max-width: 767px) {
        .fc .fc-toolbar-title { font-size: 1.1em; }
        .fc .fc-button { padding: .2em .5em; font-size: 0.9em; }
        .fc-daygrid-event-harness, .fc-list-event-title { font-size: 0.8em !important; }
        #calendarModal .w-full { max-height: 95vh; }
        .fc .fc-col-header-cell-cushion { font-weight: normal; font-size: 0.75em; }
        .fc .fc-daygrid-day-number { font-size: 0.8em; }
      }
      /* ]]> */
    </style>
  </head>
  <body class='text-gray-800 flex flex-col min-h-screen'>
   
    <b:section class='main' id='main' showaddelement='yes'>
      <b:widget id='Blog1' locked='true' title='Blog Posts' type='Blog' version='1'>
        <b:widget-settings>
          <b:widget-setting name='showDateHeader'>true</b:widget-setting>
          <b:widget-setting name='style.textcolor'>#ffffff</b:widget-setting>
          <b:widget-setting name='showShareButtons'>true</b:widget-setting>
          <b:widget-setting name='authorLabel'>By</b:widget-setting>
          <b:widget-setting name='showCommentLink'>true</b:widget-setting>
          <b:widget-setting name='style.urlcolor'>#ffffff</b:widget-setting>
          <b:widget-setting name='showAuthor'>false</b:widget-setting>
          <b:widget-setting name='style.linkcolor'>#ffffff</b:widget-setting>
          <b:widget-setting name='style.unittype'>TextAndImage</b:widget-setting>
          <b:widget-setting name='style.bgcolor'>#ffffff</b:widget-setting>
          <b:widget-setting name='reactionsLabel'/>
          <b:widget-setting name='showAuthorProfile'>false</b:widget-setting>
          <b:widget-setting name='style.layout'>1x1</b:widget-setting>
          <b:widget-setting name='showLabels'>true</b:widget-setting>
          <b:widget-setting name='showLocation'>true</b:widget-setting>
          <b:widget-setting name='showTimestamp'>true</b:widget-setting>
          <b:widget-setting name='postsPerAd'>3</b:widget-setting>
          <b:widget-setting name='showBacklinks'>false</b:widget-setting>
          <b:widget-setting name='style.bordercolor'>#ffffff</b:widget-setting>
          <b:widget-setting name='showInlineAds'>true</b:widget-setting>
          <b:widget-setting name='showReactions'>false</b:widget-setting>
        </b:widget-settings>
        <b:includable id='main' var='top'>
              <div class='flex flex-col flex-grow' id='content-wrapper'>
                <header class='px-3 pt-3 pb-1 md:py-6'>
                  <div class='container mx-auto max-w-4xl flex items-center justify-between gap-4'>
                    <div class='flex items-center gap-4'>
                      <img alt='Logo IAIN Bone' class='h-10 w-10 object-contain' src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEivDAkuxazRpasK-Kj0Tf1RXGNSrUoVyfvMyq-lXn_NBI2wXgCdjb1CBLGR7sC-r5cGU6njQnQ3TG551VMK03pSui50uEU5Ot8ScLiKskrcY-2yjuNt_xt8jnGcIjCPCtXN7yzb_9Me6G2ceSWv55vF_ZDTCk8tF0zseZ4fdrW764wiSlnBMLItY_4xdyY/s1600/logoiainbone%20-%20Copy%20%283%20%282%29.png'/>
                      <h1 class='text-xl font-bold text-brand-green'>Layanan IAIN Bone</h1>
                    </div>
                    <section class='hidden md:flex items-center gap-2' id='tracking-section'>
                      <form class='flex items-center gap-2' id='trackingForm'>
                          <input class='px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-800 focus:border-transparent transition text-sm font-normal w-48' id='permohonanId' placeholder='Ketik ID Permohonan Anda' required='required' type='text'/>
                          <select class='px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-800 focus:border-transparent transition bg-white text-sm font-normal w-48' id='trackingLayananSelect'>
                              <option value=''>Pilih Jenis Layanan</option>
                          </select>
                          <button class='bg-brand-green text-white p-2.5 rounded-lg hover:opacity-90 transition flex items-center justify-center text-lg' id='trackButton' type='submit'>
                              <i class='fas fa-search' id='trackButtonIcon'/>
                              <div class='hidden animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white' id='trackButtonSpinner'/>
                          </button>
                      </form>
                    </section>
                  </div>
                  <div class='container mx-auto max-w-4xl mt-4' id='trackingResult'/>
                </header>
               
                <main class='container mx-auto px-4 pt-0 pb-2 sm:p-6 max-w-4xl flex-grow'>
                  <div id='skeleton-loader'>
                    <div class='mb-4 md:mb-8 animate-pulse'>
                      <div class='h-6 w-1/3 bg-gray-200 rounded-md mb-4'/>
                      <div class='grid grid-cols-1 md:grid-cols-2 gap-4'>
                        <div class='h-32 bg-gray-200 rounded-xl'/>
                        <div class='h-32 bg-gray-200 rounded-xl hidden md:block'/>
                      </div>
                    </div>
                    <div class='mb-4 md:mb-8 animate-pulse'>
                      <div class='h-6 w-1/4 bg-gray-200 rounded-md mb-4'/>
                      <div class='grid grid-cols-5 sm:grid-cols-8 lg:grid-cols-10 gap-4'>
                        <script>// <![CDATA[
                          document.write(Array(10).fill('<div class="flex flex-col items-center space-y-2"><div class="w-12 h-12 bg-gray-200 rounded-xl"></div><div class="h-3 w-10 bg-gray-200 rounded"></div></div>').join(''))
                        // ]]></script>
                      </div>
                    </div>
                     <div class='mb-4 md:mb-8 animate-pulse'>
                        <div class='flex space-x-4 mb-4'>
                          <div class='h-8 w-24 bg-gray-200 rounded-full'/>
                          <div class='h-8 w-24 bg-gray-200 rounded-full'/>
                        </div>
                        <div class='bg-gray-200 p-6 rounded-xl h-48'/>
                     </div>
                  </div>
                  
                  <div class='hidden' id='real-content'>
                     <div class='mb-4 md:mb-8'>
                      <h2 class='text-base font-semibold mb-4 text-gray-800' id='top-section-title'>Informasi Penting</h2>
                      <div id='top-content-wrapper'>
                          <section id='info-section'>
                            <h3 class='text-base font-semibold mb-4 text-gray-800 md:hidden' id='info-section-title'/>
                            <div class='swiper info-swiper'>
                              <div class='swiper-wrapper' id='infoContainer'/>
                              <div class='swiper-pagination'/>
                            </div>
                          </section>
                          <section id='pinned-section'>
                            <div class='grid grid-cols-1 gap-4' id='pinnedContainer'/>
                          </section>
                      </div>
                    </div>
                    <section class='mb-4 md:mb-8' id='quicklink-section'>
                      <div class='flex justify-between items-center mb-4'>
                        <h2 class='text-base font-semibold text-gray-800'>Quick Links</h2>
                      </div>
                      <div class='grid grid-cols-5 sm:grid-cols-8 lg:grid-cols-10 gap-4 text-center' id='quicklinkContainer'/>
                      <div class='mt-8 p-1.5 bg-gray-100 rounded-full flex items-center max-w-sm mx-auto shadow-inner' id='userTypeToggleContainer'>
                        <a class='toggle-btn active flex-1 text-center py-2 rounded-full text-xs transition-all duration-300' href='#' id='toggleToUmum'>Mahasiswa/Umum</a>
                        <a class='toggle-btn flex-1 text-center py-2 rounded-full text-gray-500 text-xs transition-all duration-300' href='#' id='toggleToInternal'>Internal</a>
                      </div>
                    </section>
                    <section class='mb-4 md:mb-8' id='layanan-section'>
                      <div class='swiper layanan-tabs-swiper mb-4'>
                        <div class='swiper-wrapper' id='layanan-tabs-container'/>
                      </div>
                      <div id='layanan-content-container'/>
                    </section>
                  </div>
          
                  <div class='text-center py-6' id='reload-container'>
                      <button class='text-sm bg-red-50 text-red-700 px-4 py-2 rounded-lg hover:bg-red-100 transition-colors font-semibold' id='reload-button'>
                          <i class='fas fa-sync-alt mr-2'/>Data Tidak Termuat sempurna ? Muat Ulang Halaman
                      </button>
                  </div>
                </main>
               
                <footer class='text-center pt-2 pb-1 md:py-8 border-t border-gray-200 container mx-auto max-w-4xl'>
                  <div class='flex flex-col md:flex-row justify-between items-center gap-4'>
                    <div class='flex justify-center md:justify-start items-center space-x-4' id='footerLinkContainer'/>
                    <div class='hidden md:block text-gray-500 text-sm'>
                      <p>&#169; 2024 IAIN Bone. All rights reserved.</p>
                    </div>
                    <div class='hidden md:block text-gray-500 text-sm font-semibold'>
                      INSTITUT AGAMA ISLAM NEGERI BONE
                    </div>
                  </div>
                </footer>
              </div>
             
              <!-- MODALS -->
              <div class='hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40' id='formModal'>
                <div class='bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col'>
                  <header class='p-4 border-b flex justify-between items-center'>
                    <h2 class='text-xl font-bold text-brand-green' id='modalTitle'>Formulir Permohonan</h2>
                    <button class='text-gray-500 hover:text-gray-800 text-2xl' id='closeModalBtn'>&#215;</button>
                  </header>
                  <main class='p-6 overflow-y-auto'>
                    <form id='permohonanForm'>
                      <!-- Input fields will be generated here by JavaScript -->
                    </form>
                  </main>
                  <footer class='p-4 bg-gray-50 border-t flex justify-end gap-4'>
                    <button class='bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300' id='cancelModalBtn' type='button'>Batal</button>
                    <button class='bg-brand-green text-white font-bold py-2 px-6 rounded-lg hover:opacity-90' form='permohonanForm' id='submitPermohonanBtn' type='submit'>Kirim</button>
                  </footer>
                </div>
              </div>
              <div class='hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50' id='notificationModal'>
                <div class='bg-white rounded-xl shadow-2xl w-full max-w-sm text-center p-6 transform transition-all scale-95 opacity-0' id='notificationModalContent'>
                  <div class='mx-auto mb-4 w-16 h-16 flex items-center justify-center rounded-full text-4xl' id='notificationIcon'/>
                  <h2 class='text-xl font-bold text-gray-800 mb-2' id='notificationTitle'/>
                  <p class='text-gray-600 mb-6' id='notificationMessage'/>
                  <button class='bg-brand-green text-white font-bold py-2 px-8 rounded-lg hover:opacity-90 w-full' id='closeNotificationBtn'>Tutup</button>
                </div>
              </div>
              <div class='hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40' id='calendarModal'>
                <div class='bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col'>
                  <header class='p-4 border-b flex justify-between items-center flex-shrink-0'>
                    <h2 class='text-xl font-bold text-brand-green'>Kalender Peminjaman</h2>
                    <button class='text-gray-500 hover:text-gray-800 text-2xl' id='closeCalendarModalBtn'>&#215;</button>
                  </header>
                  <main class='p-4 overflow-hidden flex-grow relative'>
                    <div class='hidden absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center z-10' id='calendarLoader'>
                      <div class='animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-brand-green'/>
                    </div>
                    <div class='h-full' id='calendar'/>
                  </main>
                </div>
              </div>
              <div class='hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40' id='searchModal'>
                  <div class='bg-white rounded-xl shadow-2xl w-full max-w-lg'>
                      <header class='p-4 border-b flex justify-between items-center'>
                          <h2 class='text-xl font-bold text-brand-green'>Lacak Permohonan</h2>
                          <button class='text-gray-500 hover:text-gray-800 text-2xl' id='closeSearchModalBtn'>&#215;</button>
                      </header>
                      <main class='p-6'>
                          <form class='space-y-3' id='mobileTrackingForm'>
                              <input class='w-full px-4 py-3 border border-gray-300 rounded-lg' id='mobilePermohonanId' placeholder='Ketik ID Permohonan Anda' required='required' type='text'/>
                              <select class='w-full px-4 py-3 border border-gray-300 rounded-lg bg-white' id='mobileTrackingLayananSelect'>
                                  <option value=''>Pilih Jenis Layanan</option>
                              </select>
                              <button class='w-full bg-brand-green text-white py-3 rounded-lg' id='mobileTrackButton' type='submit'>Lacak</button>
                          </form>
                          <div class='mt-4' id='mobileTrackingResult'/>
                      </main>
                  </div>
              </div>
              <div class='hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40' id='helpdeskModal'>
                  <div class='bg-white rounded-xl shadow-2xl w-full max-w-lg'>
                      <header class='p-4 border-b flex justify-between items-center'>
                          <h2 class='text-xl font-bold text-brand-green'>Help Desk</h2>
                          <button class='text-gray-500 hover:text-gray-800 text-2xl' id='closeHelpdeskModalBtn'>&#215;</button>
                      </header>
                      <main class='p-6'>
                          <form class='space-y-4' id='helpdeskForm'>
                              <input class='w-full px-4 py-2 border rounded-lg' name='Nama' placeholder='Nama Anda' required='required' type='text'/>
                              <input class='w-full px-4 py-2 border rounded-lg' name='Kontak' placeholder='Kontak (WA/Email)' required='required' type='text'/>
                              <textarea class='w-full px-4 py-2 border rounded-lg' name='Pesan' placeholder='Pesan Anda' required='required' rows='4'/>
                              <button class='w-full bg-brand-green text-white py-3 rounded-lg' id='submitHelpdeskBtn' type='submit'>Kirim</button>
                          </form>
                      </main>
                  </div>
              </div>
              <div class='hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40' id='quickServicesModal'>
                  <div class='bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col'>
                      <header class='p-4 border-b flex justify-between items-center'>
                          <h2 class='text-xl font-bold text-brand-green'>Link Cepat Layanan</h2>
                          <button class='text-gray-500 hover:text-gray-800 text-2xl' id='closeQuickServicesModalBtn'>&#215;</button>
                      </header>
                      <main class='p-6 overflow-y-auto' id='quickServicesContainer'>
                          <!-- Daftar layanan akan dirender di sini -->
                      </main>
                  </div>
              </div>
             
              <!-- BOTTOM NAVIGATION & FAB -->
              <nav class='block md:hidden fixed bottom-0 left-0 w-full bg-white/80 backdrop-blur-sm shadow-[0_-1px_4px_rgba(0,0,0,0.08)] z-30' id='bottom-nav'>
                  <div class='flex justify-around items-center h-16'>
                      <button class='flex flex-col items-center text-brand-green' id='navHome'><i class='fas fa-home text-xl'/><span class='text-xs'>Beranda</span></button>
                      <button class='flex flex-col items-center text-gray-500' id='navSearch'><i class='fas fa-search text-xl'/><span class='text-xs'>Cari</span></button>
                      <button class='flex flex-col items-center text-gray-500' id='navServices'><i class='fas fa-th-large text-xl'/><span class='text-xs'>Layanan</span></button>
                      <button class='flex flex-col items-center text-gray-500' id='navHelp'><i class='fas fa-headset text-xl'/><span class='text-xs'>Bantuan</span></button>
                      <a class='flex flex-col items-center text-gray-500' href='https://layanan.iain-bone.ac.id/p/admin' id='navLogin' target='_blank'><i class='fas fa-user-shield text-xl'/><span class='text-xs'>Admin</span></a>
                  </div>
              </nav>
             
              <div class='hidden md:flex fixed bottom-8 right-8 z-30 flex-col items-center space-y-3'>
                <button class='bg-white text-brand-green w-14 h-14 rounded-full shadow-lg hover:bg-gray-100 transition flex items-center justify-center text-2xl' id='fabHelpdeskBtn' title='Bantuan'><i class='fas fa-headset'/></button>
                <a class='bg-brand-green text-white w-14 h-14 rounded-full shadow-lg hover:opacity-90 transition flex items-center justify-center text-2xl' href='https://layanan.iain-bone.ac.id/p/admin' target='_blank' title='Login Admin'><i class='fas fa-user-shield'/></a>
              </div>
            </b:includable>
        <b:includable id='backlinkDeleteIcon' var='backlink'/>
        <b:includable id='backlinks' var='post'/>
        <b:includable id='comment-form' var='post'>
  <div class='comment-form'>
    <a name='comment-form'/>
    <b:if cond='data:mobile'>
      <h4 id='comment-post-message'>
        <a expr:id='data:widget.instanceId + &quot;_comment-editor-toggle-link&quot;' href='javascript:void(0)'><data:postCommentMsg/></a></h4>
      <p><data:blogCommentMessage/></p>
      <data:blogTeamBlogMessage/>
      <a expr:href='data:post.commentFormIframeSrc' id='comment-editor-src'/>
      <iframe allowtransparency='true' class='blogger-iframe-colorize blogger-comment-from-post' expr:height='data:cmtIframeInitialHeight' frameborder='0' id='comment-editor' name='comment-editor' src='' style='display: none' width='100%'/>
    <b:else/>
      <h4 id='comment-post-message'><data:postCommentMsg/></h4>
      <p><data:blogCommentMessage/></p>
      <data:blogTeamBlogMessage/>
      <a expr:href='data:post.commentFormIframeSrc' id='comment-editor-src'/>
      <iframe allowtransparency='true' class='blogger-iframe-colorize blogger-comment-from-post' expr:height='data:cmtIframeInitialHeight' frameborder='0' id='comment-editor' name='comment-editor' src='' width='100%'/>
    </b:if>
    <data:post.cmtfpIframe/>
    <script type='text/javascript'>
      BLOG_CMT_createIframe(&#39;<data:post.appRpcRelayPath/>&#39;);
    </script>
  </div>
</b:includable>
        <b:includable id='commentDeleteIcon' var='comment'>
  <span expr:class='&quot;item-control &quot; + data:comment.adminClass'>
    <b:if cond='data:showCmtPopup'>
      <div class='goog-toggle-button'>
        <div class='goog-inline-block comment-action-icon'/>
      </div>
    <b:else/>
      <a class='comment-delete' expr:href='data:comment.deleteUrl' expr:title='data:top.deleteCommentMsg'>
        <img src='https://resources.blogblog.com/img/icon_delete13.gif'/>
      </a>
    </b:if>
  </span>
</b:includable>
        <b:includable id='comment_count_picker' var='post'>
  <a class='comment-link' expr:href='data:post.addCommentUrl' expr:onclick='data:post.addCommentOnclick'>
    <data:post.commentLabelFull/>:
  </a>
</b:includable>
        <b:includable id='comment_picker' var='post'>
  <b:if cond='data:post.showThreadedComments'>
    <b:include data='post' name='threaded_comments'/>
  <b:else/>
    <b:include data='post' name='comments'/>
  </b:if>
</b:includable>
        <b:includable id='comments' var='post'>
  <div class='comments' id='comments'>
    <a name='comments'/>
    <b:if cond='data:post.allowComments'>
      <h4><data:post.commentLabelFull/>:</h4>

      <b:if cond='data:post.commentPagingRequired'>
        <span class='paging-control-container'>
          <b:if cond='data:post.hasOlderLinks'>
            <a expr:class='data:post.oldLinkClass' expr:href='data:post.oldestLinkUrl'><data:post.oldestLinkText/></a>
              &#160;
            <a expr:class='data:post.oldLinkClass' expr:href='data:post.olderLinkUrl'><data:post.olderLinkText/></a>
              &#160;
          </b:if>

          <data:post.commentRangeText/>

          <b:if cond='data:post.hasNewerLinks'>
            &#160;
            <a expr:class='data:post.newLinkClass' expr:href='data:post.newerLinkUrl'><data:post.newerLinkText/></a>
            &#160;
            <a expr:class='data:post.newLinkClass' expr:href='data:post.newestLinkUrl'><data:post.newestLinkText/></a>
          </b:if>
        </span>
      </b:if>

      <div expr:id='data:widget.instanceId + &quot;_comments-block-wrapper&quot;'>
        <dl expr:class='data:post.avatarIndentClass' id='comments-block'>
          <b:loop values='data:post.comments' var='comment'>
            <dt expr:class='&quot;comment-author &quot; + data:comment.authorClass' expr:id='data:comment.anchorName'>
              <b:if cond='data:comment.favicon'>
                <img expr:src='data:comment.favicon' height='16px' style='margin-bottom:-2px;' width='16px'/>
              </b:if>
              <a expr:name='data:comment.anchorName'/>
              <b:if cond='data:blog.enabledCommentProfileImages'>
                <data:comment.authorAvatarImage/>
              </b:if>
              <b:if cond='data:comment.authorUrl'>
                <a expr:href='data:comment.authorUrl' rel='nofollow'><data:comment.author/></a>
              <b:else/>
                <data:comment.author/>
              </b:if>
              <data:commentPostedByMsg/>
            </dt>
            <dd class='comment-body' expr:id='data:widget.instanceId + data:comment.cmtBodyIdPostfix'>
              <b:if cond='data:comment.isDeleted'>
                <span class='deleted-comment'><data:comment.body/></span>
              <b:else/>
                <p>
                  <data:comment.body/>
                </p>
              </b:if>
            </dd>
            <dd class='comment-footer'>
              <span class='comment-timestamp'>
                <a expr:href='data:comment.url' title='comment permalink'>
                  <data:comment.timestamp/>
                </a>
                <b:include data='comment' name='commentDeleteIcon'/>
              </span>
            </dd>
          </b:loop>
        </dl>
      </div>

      <b:if cond='data:post.commentPagingRequired'>
        <span class='paging-control-container'>
          <a expr:class='data:post.oldLinkClass' expr:href='data:post.oldestLinkUrl'>
            <data:post.oldestLinkText/>
          </a>
          <a expr:class='data:post.oldLinkClass' expr:href='data:post.olderLinkUrl'>
            <data:post.olderLinkText/>
          </a>
          &#160;
          <data:post.commentRangeText/>
          &#160;
          <a expr:class='data:post.newLinkClass' expr:href='data:post.newerLinkUrl'>
            <data:post.newerLinkText/>
          </a>
          <a expr:class='data:post.newLinkClass' expr:href='data:post.newestLinkUrl'>
            <data:post.newestLinkText/>
          </a>
        </span>
      </b:if>

      <p class='comment-footer'>
        <b:if cond='data:post.embedCommentForm'>
          <b:if cond='data:post.allowNewComments'>
            <b:include data='post' name='comment-form'/>
          <b:else/>
            <data:post.noNewCommentsText/>
          </b:if>
        <b:elseif cond='data:post.allowComments'/>
          <a expr:href='data:post.addCommentUrl' expr:onclick='data:post.addCommentOnclick'><data:postCommentMsg/></a>
        </b:if>
      </p>
    </b:if>
    <b:if cond='data:showCmtPopup'>
      <div id='comment-popup'>
        <iframe allowtransparency='true' frameborder='0' id='comment-actions' name='comment-actions' scrolling='no'>
        </iframe>
      </div>
    </b:if>

  </div>
</b:includable>
        <b:includable id='feedLinks'>
  <b:if cond='data:blog.pageType != &quot;item&quot;'> <!-- Blog feed links -->
    <b:if cond='data:feedLinks'>
      <div class='blog-feeds'>
        <b:include data='feedLinks' name='feedLinksBody'/>
      </div>
    </b:if>

  <b:else/> <!--Post feed links -->
    <div class='post-feeds'>
      <b:loop values='data:posts' var='post'>
        <b:include cond='data:post.allowComments and data:post.feedLinks' data='post.feedLinks' name='feedLinksBody'/>
      </b:loop>
    </div>
  </b:if>
</b:includable>
        <b:includable id='feedLinksBody' var='links'>
  <div class='feed-links'>
  <data:feedLinksMsg/>
  <b:loop values='data:links' var='f'>
     <a class='feed-link' expr:href='data:f.url' expr:type='data:f.mimeType' target='_blank'><data:f.name/> (<data:f.feedType/>)</a>
  </b:loop>
  </div>
</b:includable>
        <b:includable id='iframe_comments' var='post'>
  <!-- G+ comments, no longer available. The includable is retained for backwards-compatibility. -->
</b:includable>
        <b:includable id='mobile-index-post' var='post'>
  <div class='mobile-date-outer date-outer'>
    <b:if cond='data:post.dateHeader'>
      <div class='date-header'>
        <span><data:post.dateHeader/></span>
      </div>
    </b:if>

    <div class='mobile-post-outer'>
      <a expr:href='data:post.url'>
        <h3 class='mobile-index-title entry-title' itemprop='name'>
          <data:post.title/>
        </h3>

        <div class='mobile-index-arrow'>&amp;rsaquo;</div>

        <div class='mobile-index-contents'>
          <b:if cond='data:post.thumbnailUrl'>
            <div class='mobile-index-thumbnail'>
              <div class='Image'>
                <img expr:src='data:post.thumbnailUrl'/>
              </div>
            </div>
          </b:if>

          <div class='post-body'>
            <b:if cond='data:post.snippet'><data:post.snippet/></b:if>
          </div>
        </div>

        <div style='clear: both;'/>
      </a>

      <div class='mobile-index-comment'>
        <b:include cond='data:blog.pageType != &quot;static_page&quot;                          and data:post.allowComments                          and data:post.numComments != 0' data='post' name='comment_count_picker'/>
      </div>
    </div>
  </div>
</b:includable>
        <b:includable id='mobile-main' var='top'>
    <!-- posts -->
    <div class='blog-posts hfeed'>

      <b:include data='top' name='status-message'/>

      <b:if cond='data:blog.pageType == &quot;index&quot;'>
        <b:loop values='data:posts' var='post'>
          <b:include data='post' name='mobile-index-post'/>
        </b:loop>
      <b:else/>
        <b:loop values='data:posts' var='post'>
          <b:include data='post' name='mobile-post'/>
        </b:loop>
      </b:if>
    </div>

   <b:include name='mobile-nextprev'/>
</b:includable>
        <b:includable id='mobile-nextprev'>
  <div class='blog-pager' id='blog-pager'>
    <b:if cond='data:newerPageUrl'>
      <div class='mobile-link-button' id='blog-pager-newer-link'>
      <a class='blog-pager-newer-link' expr:href='data:newerPageUrl' expr:id='data:widget.instanceId + &quot;_blog-pager-newer-link&quot;' expr:title='data:newerPageTitle'>&amp;lsaquo;</a>
      </div>
    </b:if>

    <b:if cond='data:olderPageUrl'>
      <div class='mobile-link-button' id='blog-pager-older-link'>
      <a class='blog-pager-older-link' expr:href='data:olderPageUrl' expr:id='data:widget.instanceId + &quot;_blog-pager-older-link&quot;' expr:title='data:olderPageTitle'>&amp;rsaquo;</a>
      </div>
    </b:if>

    <div class='mobile-link-button' id='blog-pager-home-link'>
    <a class='home-link' expr:href='data:blog.homepageUrl'><data:homeMsg/></a>
    </div>

    <div class='mobile-desktop-link'>
      <a class='home-link' expr:href='data:desktopLinkUrl'><data:desktopLinkMsg/></a>
    </div>

  </div>
  <div class='clear'/>
</b:includable>
        <b:includable id='mobile-post' var='post'>
  <div class='date-outer'>
    <b:if cond='data:post.dateHeader'>
      <h2 class='date-header'><span><data:post.dateHeader/></span></h2>
    </b:if>
    <div class='date-posts'>
      <div class='post-outer'>

        <div class='post hentry uncustomized-post-template' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
          <b:if cond='data:post.thumbnailUrl'>
            <meta expr:content='data:post.thumbnailUrl' itemprop='image_url'/>
          </b:if>
          <meta expr:content='data:blog.blogId' itemprop='blogId'/>
          <meta expr:content='data:post.id' itemprop='postId'/>

          <a expr:name='data:post.id'/>
          <b:if cond='data:post.title'>
            <h3 class='post-title entry-title' itemprop='name'>
              <b:if cond='data:post.link'>
                <a expr:href='data:post.link'><data:post.title/></a>
              <b:elseif cond='data:post.url and data:blog.url != data:post.url'/>
                <a expr:href='data:post.url'><data:post.title/></a>
              <b:else/>
                <data:post.title/>
              </b:if>
            </h3>
          </b:if>

          <div class='post-header'>
            <div class='post-header-line-1'/>
          </div>

          <div class='post-body entry-content' expr:id='&quot;post-body-&quot; + data:post.id' itemprop='articleBody'>
            <data:post.body/>
            <div style='clear: both;'/> <!-- clear for photos floats -->
          </div>

          <div class='post-footer'>
            <div class='post-footer-line post-footer-line-1'>
              <span class='post-author vcard'>
                <b:if cond='data:top.showAuthor'>
                  <b:if cond='data:post.authorProfileUrl'>
                    <span class='fn' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
                      <meta expr:content='data:post.authorProfileUrl' itemprop='url'/>
                      <a expr:href='data:post.authorProfileUrl' rel='author' title='author profile'>
                        <span itemprop='name'><data:post.author/></span>
                      </a>
                    </span>
                  <b:else/>
                    <span class='fn' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
                      <span itemprop='name'><data:post.author/></span>
                    </span>
                  </b:if>
                </b:if>
              </span>

              <span class='post-timestamp'>
                <b:if cond='data:top.showTimestamp'>
                  <data:top.timestampLabel/>
                  <b:if cond='data:post.url'>
                    <meta expr:content='data:post.url.canonical' itemprop='url'/>
                    <a class='timestamp-link' expr:href='data:post.url' rel='bookmark' title='permanent link'><abbr class='published' expr:title='data:post.timestampISO8601' itemprop='datePublished'><data:post.timestamp/></abbr></a>
                  </b:if>
                </b:if>
              </span>

              <span class='post-comment-link'>
                <b:include cond='data:blog.pageType not in {&quot;item&quot;,&quot;static_page&quot;}                                  and data:post.allowComments' data='post' name='comment_count_picker'/>
              </span>
            </div>

            <div class='post-footer-line post-footer-line-2'>
              <b:if cond='data:top.showMobileShare'>
                <div class='mobile-link-button goog-inline-block' id='mobile-share-button'>
                  <a href='javascript:void(0);'><data:shareMsg/></a>
                </div>
              </b:if>
            </div>

          </div>
        </div>

        <b:include cond='data:blog.pageType in {&quot;static_page&quot;,&quot;item&quot;}' data='post' name='comment_picker'/>
      </div>
    </div>
  </div>
</b:includable>
        <b:includable id='nextprev'>
  <div class='blog-pager' id='blog-pager'>
    <b:if cond='data:newerPageUrl'>
      <span id='blog-pager-newer-link'>
      <a class='blog-pager-newer-link' expr:href='data:newerPageUrl' expr:id='data:widget.instanceId + &quot;_blog-pager-newer-link&quot;' expr:title='data:newerPageTitle'><data:newerPageTitle/></a>
      </span>
    </b:if>

    <b:if cond='data:olderPageUrl'>
      <span id='blog-pager-older-link'>
      <a class='blog-pager-older-link' expr:href='data:olderPageUrl' expr:id='data:widget.instanceId + &quot;_blog-pager-older-link&quot;' expr:title='data:olderPageTitle'><data:olderPageTitle/></a>
      </span>
    </b:if>

    <a class='home-link' expr:href='data:blog.homepageUrl'><data:homeMsg/></a>

    <b:if cond='data:mobileLinkUrl'>
      <div class='blog-mobile-link'>
        <a expr:href='data:mobileLinkUrl'><data:mobileLinkMsg/></a>
      </div>
    </b:if>

  </div>
  <div class='clear'/>
</b:includable>
        <b:includable id='post' var='post'>
  <div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
    <b:if cond='data:post.firstImageUrl'>
      <meta expr:content='data:post.firstImageUrl' itemprop='image_url'/>
    </b:if>
    <meta expr:content='data:blog.blogId' itemprop='blogId'/>
    <meta expr:content='data:post.id' itemprop='postId'/>

    <a expr:name='data:post.id'/>
    <b:if cond='data:post.title'>
      <h3 class='post-title entry-title' itemprop='name'>
      <b:if cond='data:post.link or (data:post.url and data:blog.url != data:post.url)'>
        <a expr:href='data:post.link ? data:post.link : data:post.url'><data:post.title/></a>
      <b:else/>
        <data:post.title/>
      </b:if>
      </h3>
    </b:if>

    <div class='post-header'>
    <div class='post-header-line-1'/>
    </div>

    <!-- Then use the post body as the schema.org description, for good G+/FB snippeting. -->
    <div class='post-body entry-content' expr:id='&quot;post-body-&quot; + data:post.id' expr:itemprop='(data:blog.metaDescription ? &quot;&quot; : &quot;description &quot;) + &quot;articleBody&quot;'>
      <data:post.body/>
      <div style='clear: both;'/> <!-- clear for photos floats -->
    </div>

    <b:if cond='data:post.hasJumpLink'>
      <div class='jump-link'>
        <a expr:href='data:post.url + &quot;#more&quot;' expr:title='data:post.title'><data:post.jumpText/></a>
      </div>
    </b:if>

    <div class='post-footer'>
    <div class='post-footer-line post-footer-line-1'>
      <span class='post-author vcard'>
        <b:if cond='data:top.showAuthor'>
          <data:top.authorLabel/>
            <b:if cond='data:post.authorProfileUrl'>
              <span class='fn' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
                <meta expr:content='data:post.authorProfileUrl' itemprop='url'/>
                <a class='g-profile' expr:href='data:post.authorProfileUrl' rel='author' title='author profile'>
                  <span itemprop='name'><data:post.author/></span>
                </a>
              </span>
            <b:else/>
              <span class='fn' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
                <span itemprop='name'><data:post.author/></span>
              </span>
            </b:if>
        </b:if>
      </span>

      <span class='post-timestamp'>
        <b:if cond='data:top.showTimestamp'>
          <data:top.timestampLabel/>
          <b:if cond='data:post.url'>
            <meta expr:content='data:post.url.canonical' itemprop='url'/>
            <a class='timestamp-link' expr:href='data:post.url' rel='bookmark' title='permanent link'><abbr class='published' expr:title='data:post.timestampISO8601' itemprop='datePublished'><data:post.timestamp/></abbr></a>
          </b:if>
        </b:if>
      </span>

      <span class='post-comment-link'>
        <b:include cond='data:blog.pageType not in {&quot;item&quot;,&quot;static_page&quot;}                          and data:post.allowComments' data='post' name='comment_count_picker'/>
      </span>

      <span class='post-icons'>
        <!-- email post links -->
        <b:if cond='data:post.emailPostUrl'>
          <span class='item-action'>
          <a expr:href='data:post.emailPostUrl' expr:title='data:top.emailPostMsg'>
            <img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
          </a>
          </span>
        </b:if>

        <!-- quickedit pencil -->
        <b:include data='post' name='postQuickEdit'/>
      </span>

      <!-- share buttons -->
      <div class='post-share-buttons goog-inline-block'>
        <b:include cond='data:post.sharePostUrl' data='post' name='shareButtons'/>
      </div>

      </div>

      <div class='post-footer-line post-footer-line-2'>
      <span class='post-labels'>
        <b:if cond='data:top.showPostLabels and data:post.labels'>
          <data:postLabelsLabel/>
          <b:loop values='data:post.labels' var='label'>
            <a expr:href='data:label.url' rel='tag'><data:label.name/></a><b:if cond='not data:label.isLast'>,</b:if>
          </b:loop>
        </b:if>
      </span>
      </div>

      <div class='post-footer-line post-footer-line-3'>
      <span class='post-location'>
        <b:if cond='data:top.showLocation and data:post.location'>
          <data:postLocationLabel/>
          <a expr:href='data:post.location.mapsUrl' target='_blank'><data:post.location.name/></a>
        </b:if>
      </span>
      </div>
      <b:if cond='data:post.authorAboutMe'>
        <div class='author-profile' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
          <b:if cond='data:post.authorPhoto.url'>
            <img expr:src='data:post.authorPhoto.url' itemprop='image' width='50px'/>
          </b:if>
          <div>
            <a class='g-profile' expr:href='data:post.authorProfileUrl' itemprop='url' rel='author' title='author profile'>
              <span itemprop='name'><data:post.author/></span>
            </a>
          </div>
          <span itemprop='description'><data:post.authorAboutMe/></span>
        </div>
      </b:if>
    </div>
  </div>
</b:includable>
        <b:includable id='postQuickEdit' var='post'>
  <b:if cond='data:post.editUrl'>
    <span expr:class='&quot;item-control &quot; + data:post.adminClass'>
      <a expr:href='data:post.editUrl' expr:title='data:top.editPostMsg'>
        <img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
      </a>
    </span>
  </b:if>
</b:includable>
        <b:includable id='shareButtons' var='post'>
  <b:if cond='data:top.showEmailButton'><a class='goog-inline-block share-button sb-email' expr:href='data:post.sharePostUrl + &quot;&amp;target=email&quot;' expr:title='data:top.emailThisMsg' target='_blank'><span class='share-button-link-text'><data:top.emailThisMsg/></span></a></b:if><b:if cond='data:top.showBlogThisButton'><a class='goog-inline-block share-button sb-blog' expr:href='data:post.sharePostUrl + &quot;&amp;target=blog&quot;' expr:onclick='&quot;window.open(this.href, \&quot;_blank\&quot;, \&quot;height=270,width=475\&quot;); return false;&quot;' expr:title='data:top.blogThisMsg' target='_blank'><span class='share-button-link-text'><data:top.blogThisMsg/></span></a></b:if><b:if cond='data:top.showTwitterButton'><a class='goog-inline-block share-button sb-twitter' expr:href='data:post.sharePostUrl + &quot;&amp;target=twitter&quot;' expr:title='data:top.shareToTwitterMsg' target='_blank'><span class='share-button-link-text'><data:top.shareToTwitterMsg/></span></a></b:if><b:if cond='data:top.showFacebookButton'><a class='goog-inline-block share-button sb-facebook' expr:href='data:post.sharePostUrl + &quot;&amp;target=facebook&quot;' expr:onclick='&quot;window.open(this.href, \&quot;_blank\&quot;, \&quot;height=430,width=640\&quot;); return false;&quot;' expr:title='data:top.shareToFacebookMsg' target='_blank'><span class='share-button-link-text'><data:top.shareToFacebookMsg/></span></a></b:if><b:if cond='data:top.showPinterestButton'><a class='goog-inline-block share-button sb-pinterest' expr:href='data:post.sharePostUrl + &quot;&amp;target=pinterest&quot;' expr:title='data:top.shareToPinterestMsg' target='_blank'><span class='share-button-link-text'><data:top.shareToPinterestMsg/></span></a></b:if>
</b:includable>
        <b:includable id='status-message'>
  <b:if cond='data:navMessage'>
  <div class='status-msg-wrap'>
    <div class='status-msg-body'>
      <data:navMessage/>
    </div>
    <div class='status-msg-border'>
      <div class='status-msg-bg'>
        <div class='status-msg-hidden'><data:navMessage/></div>
      </div>
    </div>
  </div>
  <div style='clear: both;'/>
  </b:if>
</b:includable>
        <b:includable id='threaded-comment-form' var='post'>
  <div class='comment-form'>
    <a name='comment-form'/>
    <b:if cond='data:mobile'>
      <p><data:blogCommentMessage/></p>
      <data:blogTeamBlogMessage/>
      <a expr:href='data:post.commentFormIframeSrc' id='comment-editor-src'/>
      <iframe allowtransparency='true' class='blogger-iframe-colorize blogger-comment-from-post' expr:height='data:cmtIframeInitialHeight' frameborder='0' id='comment-editor' name='comment-editor' src='' style='display: none' width='100%'/>
    <b:else/>
      <p><data:blogCommentMessage/></p>
      <data:blogTeamBlogMessage/>
      <a expr:href='data:post.commentFormIframeSrc' id='comment-editor-src'/>
      <iframe allowtransparency='true' class='blogger-iframe-colorize blogger-comment-from-post' expr:height='data:cmtIframeInitialHeight' frameborder='0' id='comment-editor' name='comment-editor' src='' width='100%'/>
    </b:if>
    <data:post.cmtfpIframe/>
    <script type='text/javascript'>
      BLOG_CMT_createIframe(&#39;<data:post.appRpcRelayPath/>&#39;);
    </script>
  </div>
</b:includable>
        <b:includable id='threaded_comment_js' var='post'>
  <script async='async' expr:src='data:post.commentSrc' type='text/javascript'/>

  <script type='text/javascript'>
    (function() {
      var items = <data:post.commentJso/>;
      var msgs = <data:post.commentMsgs/>;
      var config = <data:post.commentConfig/>;

// <![CDATA[
      var cursor = null;
      if (items && items.length > 0) {
        cursor = parseInt(items[items.length - 1].timestamp) + 1;
      }

      var bodyFromEntry = function(entry) {
        var text = (entry &&
                    ((entry.content && entry.content.$t) ||
                     (entry.summary && entry.summary.$t))) ||
            '';
        if (entry && entry.gd$extendedProperty) {
          for (var k in entry.gd$extendedProperty) {
            if (entry.gd$extendedProperty[k].name == 'blogger.contentRemoved') {
              return '<span class="deleted-comment">' + text + '</span>';
            }
          }
        }
        return text;
      }

      var parse = function(data) {
        cursor = null;
        var comments = [];
        if (data && data.feed && data.feed.entry) {
          for (var i = 0, entry; entry = data.feed.entry[i]; i++) {
            var comment = {};
            // comment ID, parsed out of the original id format
            var id = /blog-(\d+).post-(\d+)/.exec(entry.id.$t);
            comment.id = id ? id[2] : null;
            comment.body = bodyFromEntry(entry);
            comment.timestamp = Date.parse(entry.published.$t) + '';
            if (entry.author && entry.author.constructor === Array) {
              var auth = entry.author[0];
              if (auth) {
                comment.author = {
                  name: (auth.name ? auth.name.$t : undefined),
                  profileUrl: (auth.uri ? auth.uri.$t : undefined),
                  avatarUrl: (auth.gd$image ? auth.gd$image.src : undefined)
                };
              }
            }
            if (entry.link) {
              if (entry.link[2]) {
                comment.link = comment.permalink = entry.link[2].href;
              }
              if (entry.link[3]) {
                var pid = /.*comments\/default\/(\d+)\?.*/.exec(entry.link[3].href);
                if (pid && pid[1]) {
                  comment.parentId = pid[1];
                }
              }
            }
            comment.deleteclass = 'item-control blog-admin';
            if (entry.gd$extendedProperty) {
              for (var k in entry.gd$extendedProperty) {
                if (entry.gd$extendedProperty[k].name == 'blogger.itemClass') {
                  comment.deleteclass += ' ' + entry.gd$extendedProperty[k].value;
                } else if (entry.gd$extendedProperty[k].name == 'blogger.displayTime') {
                  comment.displayTime = entry.gd$extendedProperty[k].value;
                }
              }
            }
            comments.push(comment);
          }
        }
        return comments;
      };

      var paginator = function(callback) {
        if (hasMore()) {
          var url = config.feed + '?alt=json&v=2&orderby=published&reverse=false&max-results=50';
          if (cursor) {
            url += '&published-min=' + new Date(cursor).toISOString();
          }
          window.bloggercomments = function(data) {
            var parsed = parse(data);
            cursor = parsed.length < 50 ? null
                : parseInt(parsed[parsed.length - 1].timestamp) + 1
            callback(parsed);
            window.bloggercomments = null;
          }
          url += '&callback=bloggercomments';
          var script = document.createElement('script');
          script.type = 'text/javascript';
          script.src = url;
          document.getElementsByTagName('head')[0].appendChild(script);
        }
      };
      var hasMore = function() {
        return !!cursor;
      };
      var getMeta = function(key, comment) {
        if ('iswriter' == key) {
          var matches = !!comment.author
              && comment.author.name == config.authorName
              && comment.author.profileUrl == config.authorUrl;
          return matches ? 'true' : '';
        } else if ('deletelink' == key) {
          return config.baseUri + '/comment/delete/'
               + config.blogId + '/' + comment.id;
        } else if ('deleteclass' == key) {
          return comment.deleteclass;
        }
        return '';
      };

      var replybox = null;
      var replyUrlParts = null;
      var replyParent = undefined;

      var onReply = function(commentId, domId) {
        if (replybox == null) {
          // lazily cache replybox, and adjust to suit this style:
          replybox = document.getElementById('comment-editor');
          if (replybox != null) {
            replybox.height = '250px';
            replybox.style.display = 'block';
            replyUrlParts = replybox.src.split('#');
          }
        }
        if (replybox && (commentId !== replyParent)) {
          replybox.src = '';
          document.getElementById(domId).insertBefore(replybox, null);
          replybox.src = replyUrlParts[0]
              + (commentId ? '&parentID=' + commentId : '')
              + '#' + replyUrlParts[1];
          replyParent = commentId;
        }
      };

      var hash = (window.location.hash || '#').substring(1);
      var startThread, targetComment;
      if (/^comment-form_/.test(hash)) {
        startThread = hash.substring('comment-form_'.length);
      } else if (/^c[0-9]+$/.test(hash)) {
        targetComment = hash.substring(1);
      }

      // Configure commenting API:
      var configJso = {
        'maxDepth': config.maxThreadDepth
      };
      var provider = {
        'id': config.postId,
        'data': items,
        'loadNext': paginator,
        'hasMore': hasMore,
        'getMeta': getMeta,
        'onReply': onReply,
        'rendered': true,
        'initComment': targetComment,
        'initReplyThread': startThread,
        'config': configJso,
        'messages': msgs
      };

      var render = function() {
        if (window.goog && window.goog.comments) {
          var holder = document.getElementById('comment-holder');
          window.goog.comments.render(holder, provider);
        }
      };

      // render now, or queue to render when library loads:
      if (window.goog && window.goog.comments) {
        render();
      } else {
        window.goog = window.goog || {};
        window.goog.comments = window.goog.comments || {};
        window.goog.comments.loadQueue = window.goog.comments.loadQueue || [];
        window.goog.comments.loadQueue.push(render);
      }
    })();
// ]]>
  </script>
</b:includable>
        <b:includable id='threaded_comments' var='post'>
  <div class='comments' id='comments'>
    <a name='comments'/>
    <h4><data:post.commentLabelFull/>:</h4>

    <div class='comments-content'>
      <b:include cond='data:post.embedCommentForm' data='post' name='threaded_comment_js'/>
      <div id='comment-holder'>
         <data:post.commentHtml/>
      </div>
    </div>

    <p class='comment-footer'>
      <b:if cond='data:post.allowNewComments'>
        <b:include data='post' name='threaded-comment-form'/>
      <b:else/>
        <data:post.noNewCommentsText/>
      </b:if>
    </p>

    <b:if cond='data:showCmtPopup'>
      <div id='comment-popup'>
        <iframe allowtransparency='true' frameborder='0' id='comment-actions' name='comment-actions' scrolling='no'>
        </iframe>
      </div>
    </b:if>

    <div id='backlinks-container'>
    <div expr:id='data:widget.instanceId + &quot;_backlinks-container&quot;'>
    </div>
    </div>
  </div>
</b:includable>
      </b:widget>
    </b:section>
    
    <script>
    // <![CDATA[
    // PENTING: Ganti URL di bawah ini dengan URL Web App BARU dari Google Apps Script Anda
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxt6xQjiZ_jU9n3x85coslxKQzUXSebeEUPJoFng0sUuJIkpD1H5O2535bPOM2V1ASvOQ/exec';

    document.addEventListener('DOMContentLoaded', function() {
 
      function showNotificationModal(title, message, type = 'info') {
        const modal = document.getElementById('notificationModal');
        const iconContainer = document.getElementById('notificationIcon');
        const titleEl = document.getElementById('notificationTitle');
        const messageEl = document.getElementById('notificationMessage');
        const closeBtn = document.getElementById('closeNotificationBtn');
        if (!modal) return;
        const hideModal = () => {
            modal.classList.remove('visible');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        };
        titleEl.textContent = title;
        messageEl.innerHTML = message;
        iconContainer.className = 'mx-auto mb-4 w-16 h-16 flex items-center justify-center rounded-full text-4xl';
        if (type === 'success') {
            iconContainer.classList.add('bg-green-100', 'text-green-600');
            iconContainer.innerHTML = `<i class="fas fa-check-circle"></i>`;
        } else if (type === 'error') {
            iconContainer.classList.add('bg-red-100', 'text-red-600');
            iconContainer.innerHTML = `<i class="fas fa-times-circle"></i>`;
        } else {
            iconContainer.classList.add('bg-blue-100', 'text-blue-600');
            iconContainer.innerHTML = `<i class="fas fa-info-circle"></i>`;
        }
        iconContainer.style.display = (type === 'custom') ? 'none' : 'flex';
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.add('visible');
        }, 10);
        closeBtn.onclick = hideModal;
        modal.onclick = (e) => {
            if (e.target === modal) {
                hideModal();
            }
        };
      }
    
      const skeletonLoader = document.getElementById('skeleton-loader');
      const realContent = document.getElementById('real-content');
      const layananTabsContainer = document.getElementById('layanan-tabs-container');
      const layananContentContainer = document.getElementById('layanan-content-container');
      const trackingForm = document.getElementById('trackingForm');
      const trackingResult = document.getElementById('trackingResult');
      const trackingLayananSelect = document.getElementById('trackingLayananSelect');
      const infoContainer = document.getElementById('infoContainer');
      const pinnedContainer = document.getElementById('pinnedContainer');
      const quicklinkContainer = document.getElementById('quicklinkContainer');
      const footerLinkContainer = document.getElementById('footerLinkContainer');
      const userTypeToggleContainer = document.getElementById('userTypeToggleContainer');
      const formModal = document.getElementById('formModal');
      const modalTitle = document.getElementById('modalTitle');
      const permohonanForm = document.getElementById('permohonanForm');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const cancelModalBtn = document.getElementById('cancelModalBtn');
      const calendarModal = document.getElementById('calendarModal');
      const closeCalendarModalBtn = document.getElementById('closeCalendarModalBtn');
      const calendarEl = document.getElementById('calendar');
      const calendarLoader = document.getElementById('calendarLoader');
      let calendar;
      const searchModal = document.getElementById('searchModal');
      const closeSearchModalBtn = document.getElementById('closeSearchModalBtn');
      const helpdeskModal = document.getElementById('helpdeskModal');
      const closeHelpdeskModalBtn = document.getElementById('closeHelpdeskModalBtn');
      const quickServicesModal = document.getElementById('quickServicesModal');
      const closeQuickServicesModalBtn = document.getElementById('closeQuickServicesModalBtn');
      const helpdeskForm = document.getElementById('helpdeskForm');
      const mobileTrackingForm = document.getElementById('mobileTrackingForm');
      const fabHelpdeskBtn = document.getElementById('fabHelpdeskBtn');
    
      let semuaLayanan = [];
      let currentUserType = 'Umum';
      let calendarDataCache = {}; // PERUBAHAN 1: Membuat cache global untuk data kalender

      handlePageRouting();
      loadAllPublicData();
      setupEventListeners();
    
      function handlePageRouting() {
          const currentPath = window.location.pathname;
          const adminUrl = "https://script.google.com/macros/s/AKfycbxubX1zq-ZsXcunAjX33WuiQSnWONGzi17R7vO5p-6jfuG_vSM8_Mqs7Obl5zfIq79w6A/exec"; 
          const lacakUrl = "https://script.google.com/macros/s/AKfycbyQoYPCtNkfhOCIWfYkh1WCd8Q4TKIyQpWGpXOv2YbiEeu8VLOKu6H2IHvhgtL764ajOg/exec";
          if (currentPath.includes('/p/admin') || currentPath.includes('/admin')) { 
              displayIframe(adminUrl, 'Halaman Admin');
          } else if (currentPath.includes('/p/lacak')) {
              displayIframe(lacakUrl, 'Halaman Lacak');
          }
      }

      function displayIframe(url, pageTitle) {
          document.title = pageTitle + " - Layanan IAIN Bone";
          const contentWrapper = document.getElementById('content-wrapper');
          if (contentWrapper) {
              contentWrapper.style.display = 'none';
          }
          const iframe = document.createElement('iframe');
          iframe.src = url;
          iframe.style.position = 'fixed';
          iframe.style.top = '0';
          iframe.style.left = '0';
          iframe.style.width = '100%';
          iframe.style.height = '100%';
          iframe.style.border = 'none';
          iframe.style.zIndex = '9999';
          document.body.innerHTML = '';
          document.body.appendChild(iframe);
          document.body.style.margin = '0';
          document.body.style.overflow = 'hidden';
      }

      function setupEventListeners() {
        if(trackingForm) trackingForm.addEventListener('submit', handleTracking);
        if(mobileTrackingForm) mobileTrackingForm.addEventListener('submit', handleMobileTracking);
        const modalClosers = [
            { btn: closeModalBtn, modal: formModal }, { btn: cancelModalBtn, modal: formModal },
            { btn: closeSearchModalBtn, modal: searchModal }, { btn: closeHelpdeskModalBtn, modal: helpdeskModal },
            { btn: closeQuickServicesModalBtn, modal: quickServicesModal }, { btn: closeCalendarModalBtn, modal: calendarModal }
        ];
        modalClosers.forEach(item => {
            if(item && item.btn) item.btn.addEventListener('click', () => item.modal.classList.add('hidden'));
        });
        const modals = [formModal, searchModal, helpdeskModal, quickServicesModal, calendarModal];
        modals.forEach(modal => {
            if(modal) modal.addEventListener('click', (e) => e.target === modal && modal.classList.add('hidden'));
        });
        if(permohonanForm) permohonanForm.addEventListener('submit', handlePermohonanSubmit);
        if(helpdeskForm) helpdeskForm.addEventListener('submit', handleHelpdeskSubmit);
        if(trackingResult) trackingResult.addEventListener('click', handleCloseTrackResult);
        if(userTypeToggleContainer) userTypeToggleContainer.addEventListener('click', toggleUserType);
        if(fabHelpdeskBtn) fabHelpdeskBtn.addEventListener('click', () => helpdeskModal.classList.remove('hidden'));
        const reloadBtn = document.getElementById('reload-button');
        if(reloadBtn) {
            reloadBtn.addEventListener('click', () => {
                reloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memuat ulang...';
                reloadBtn.disabled = true;
                skeletonLoader.classList.remove('hidden');
                realContent.classList.add('hidden');
                loadAllPublicData();
            });
        }
        function handleLinkClick(event) {
            const link = event.target.closest('a');
            if (link && link.href) {
                const textElement = link.querySelector('p');
                const itemName = `Klik: ${ (textElement) ? textElement.textContent.trim() : link.dataset.itemName}`;
                if (itemName) {
                    fetch(GAS_WEB_APP_URL + '?action=recordClick&itemName=' + encodeURIComponent(itemName));
                }
            }
        }
        [infoContainer, pinnedContainer, quicklinkContainer, footerLinkContainer].forEach(container => {
            if(container) container.addEventListener('click', handleLinkClick);
        });
        const navHome = document.getElementById('navHome');
        const navSearch = document.getElementById('navSearch');
        const navServices = document.getElementById('navServices');
        const navHelp = document.getElementById('navHelp');
        if(navHome) navHome.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
        if(navSearch) navSearch.addEventListener('click', () => searchModal.classList.remove('hidden'));
        if(navServices) navServices.addEventListener('click', () => quickServicesModal.classList.remove('hidden'));
        if(navHelp) navHelp.addEventListener('click', () => helpdeskModal.classList.remove('hidden'));
      }

      function handleCloseTrackResult(e) {
        if (e.target.closest('.js-close-track-result')) {
          trackingResult.innerHTML = '';
          document.getElementById('permohonanId').value = '';
          trackingLayananSelect.selectedIndex = 0;
        }
      }
      
      // PERUBAHAN 2: Fungsi baru untuk memuat data kalender di latar belakang
      function prefetchCalendarData(layananList) {
        const calendarServices = layananList.filter(l => (getValueCaseInsensitive(l, 'jenis') || '').toLowerCase() === 'kalender');
        
        calendarServices.forEach(service => {
          const sheet = getValueCaseInsensitive(service, 'sheet');
          const sheetId = getValueCaseInsensitive(service, 'Sheet ID') || '';
          if (sheet) {
            const cacheKey = `${sheet}-${sheetId}`;
            // Hanya fetch jika belum ada di cache
            if (!calendarDataCache[cacheKey]) {
               console.log(`Prefetching calendar data for: ${sheet}`);
               fetch(`${GAS_WEB_APP_URL}?action=getCalendarEvents&sheetName=${encodeURIComponent(sheet)}&sheetId=${encodeURIComponent(sheetId)}`)
                 .then(res => res.json())
                 .then(events => {
                   // Simpan hasil ke cache
                   calendarDataCache[cacheKey] = Array.isArray(events) ? events : [];
                   console.log(`Cache updated for: ${sheet}`);
                 })
                 .catch(err => console.error(`Failed to prefetch calendar data for ${sheet}:`, err));
            }
          }
        });
      }

      function loadAllPublicData() {
        if (document.getElementById('content-wrapper').style.display === 'none') return;
    
        const CACHE_KEY = 'allPublicDataCache';
        const CACHE_DURATION_MS = 5 * 60 * 1000; // Cache berlaku selama 5 menit
    
        // --- LANGKAH 1: Coba muat data dari cache terlebih dahulu ---
        const cachedItemStr = localStorage.getItem(CACHE_KEY);
        let isLoadedFromCache = false;
        if (cachedItemStr) {
            try {
                const cachedItem = JSON.parse(cachedItemStr);
                const isExpired = Date.now() - cachedItem.timestamp > CACHE_DURATION_MS;
                if (!isExpired) {
                    console.log("Memuat data dari cache untuk tampilan cepat...");
                    skeletonLoader.classList.add('hidden');
                    realContent.classList.remove('hidden');
                    onLayananSuccess(cachedItem.data.layanan || []);
                    onInfoSuccess(cachedItem.data.info || []);
                    isLoadedFromCache = true;
                }
            } catch (e) {
                // Jika ada error pada data cache, hapus saja
                localStorage.removeItem(CACHE_KEY);
            }
        }
    
        // --- LANGKAH 2: Selalu ambil data terbaru dari jaringan di latar belakang ---
        console.log("Mengambil data baru dari jaringan...");
        const layananPromise = fetch(GAS_WEB_APP_URL + '?action=getPublicLayanan').then(res => res.json());
        const infoPromise = fetch(GAS_WEB_APP_URL + '?action=getPublicInfo').then(res => res.json());
    
        Promise.allSettled([layananPromise, infoPromise])
          .then((results) => {
              const layananSuccess = results[0].status === 'fulfilled';
              const infoSuccess = results[1].status === 'fulfilled';
    
              if (layananSuccess && infoSuccess) {
                  const freshLayananData = results[0].value || [];
                  const freshInfoData = results[1].value || [];
    
                  // Tampilkan konten jika belum ditampilkan dari cache
                  if (!isLoadedFromCache) {
                      skeletonLoader.classList.add('hidden');
                      realContent.classList.remove('hidden');
                  }
    
                  // Render data terbaru dari jaringan
                  onLayananSuccess(freshLayananData);
                  onInfoSuccess(freshInfoData);
    
                  // --- LANGKAH 3: Simpan data terbaru ke cache untuk kunjungan berikutnya ---
                  const itemToCache = {
                      data: {
                          layanan: freshLayananData,
                          info: freshInfoData
                      },
                      timestamp: Date.now()
                  };
                  localStorage.setItem(CACHE_KEY, JSON.stringify(itemToCache));
                  console.log("Cache diperbarui dengan data baru.");
    
              } else {
                  // Jika pengambilan data gagal DAN tidak ada cache, baru tampilkan error
                  if (!isLoadedFromCache) {
                      if (!layananSuccess) onLayananFailure(results[0].reason);
                      if (!infoSuccess) onInfoFailure(results[1].reason);
                  }
              }
              const reloadBtn = document.getElementById('reload-button');
              if (reloadBtn) {
                  reloadBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Data Tidak Termuat sempurna ? Muat Ulang Halaman';
                  reloadBtn.disabled = false;
              }
          });
    
        fetch(GAS_WEB_APP_URL + '?action=recordVisit');
      }
      
      function getValueCaseInsensitive(object, key) {
        if (!object || !key) return undefined;
        const asLowercase = key.toLowerCase();
        const keyFound = Object.keys(object).find(k => k.toLowerCase().trim() === asLowercase);
        return object[keyFound];
      }

      function getTextColorForBg(hexColor) {
        if (!hexColor || hexColor.length < 4) return 'text-white';
        let shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
        hexColor = hexColor.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b);
        let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hexColor);
        if (!result) return 'text-white';
        const r = parseInt(result[1], 16);
        const g = parseInt(result[2], 16);
        const b = parseInt(result[3], 16);
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b);
        return luminance > 150 ? 'text-gray-800' : 'text-white';
      }
    
      function getIconForLayanan(layanan) {
        const customIcon = getValueCaseInsensitive(layanan, 'icon');
        if (customIcon && customIcon.toString().trim() !== '') {
          return customIcon.toString().trim();
        }
        return 'concierge-bell';
      }
    
      function getFooterIcon(text) {
          const lowerText = text.toLowerCase();
          if (lowerText.includes('facebook')) return 'fab fa-facebook-f';
          if (lowerText.includes('instagram')) return 'fab fa-instagram';
          if (lowerText.includes('youtube')) return 'fab fa-youtube';
          if (lowerText.includes('tiktok')) return 'fab fa-tiktok';
          if (lowerText.includes('website')) return 'fas fa-globe';
          return 'fas fa-link';
      }

      function onLayananSuccess(data) {
        semuaLayanan = data || [];
        if (!semuaLayanan || semuaLayanan.length === 0) {
          layananTabsContainer.innerHTML = '';
          layananContentContainer.innerHTML = '<p class="text-gray-500 text-center p-4">Tidak ada layanan yang tersedia.</p>';
          return;
        }
        renderLayananByFilter(currentUserType);
        const mobileTrackingSelect = document.getElementById('mobileTrackingLayananSelect');
        trackingLayananSelect.innerHTML = '<option value="">Pilih Jenis Layanan</option>';
        if(mobileTrackingSelect) mobileTrackingSelect.innerHTML = '<option value="">Pilih Jenis Layanan</option>';
      
        const trackableLayanan = semuaLayanan.filter(layanan => (getValueCaseInsensitive(layanan, 'jenis') || '').toLowerCase() !== 'setting');
        trackableLayanan.forEach(layanan => {
          const layananName = getValueCaseInsensitive(layanan, 'jenis layanan');
          const targetSheet = getValueCaseInsensitive(layanan, 'sheet');
          const targetSheetId = getValueCaseInsensitive(layanan, 'Sheet ID') || '';
          if (layananName && targetSheet) {
            const optionValue = JSON.stringify({ name: targetSheet, id: targetSheetId });
            const option = `<option value='${optionValue}'>${layananName}</option>`;
            trackingLayananSelect.innerHTML += option;
            if(mobileTrackingSelect) mobileTrackingSelect.innerHTML += option;
          }
        });
        renderQuickServicesModal();

        // PERUBAHAN 3: Panggil fungsi prefetch setelah semua layanan berhasil dimuat
        prefetchCalendarData(semuaLayanan);
      }

      function onLayananFailure(error) {
        console.error('Gagal memuat layanan:', error);
        layananContentContainer.innerHTML = '<p class="text-red-500 col-span-full p-4 text-center">Gagal memuat daftar layanan. Silakan muat ulang.</p>';
      }
      function onInfoSuccess(allData) {
        const infoItems = [], pinItems = [], linkItems = [], footerLinkItems = [];
        (allData || []).forEach(item => {
          const jenis = (getValueCaseInsensitive(item, 'jenis') || '').toLowerCase();
          if (jenis === 'info') infoItems.push(item);
          else if (jenis === 'pin') pinItems.push(item);
          else if (jenis === 'link') linkItems.push(item);
          else if (jenis === 'footer link') footerLinkItems.push(item);
        });
        const topWrapper = document.getElementById('top-content-wrapper');
        const topSectionTitle = document.getElementById('top-section-title');
        if(infoItems.length >= 1 && pinItems.length >= 1) {
          topWrapper.className = 'grid grid-cols-1 md:grid-cols-2 md:gap-8 items-start';
          topSectionTitle.classList.add('hidden');
        } else {
          topWrapper.className = '';
          topSectionTitle.classList.remove('hidden');
        }
        renderInfoSlider(infoItems);
        renderPinnedButtons(pinItems);
        renderQuickLinks(linkItems);
        renderFooterLinks(footerLinkItems);
      }
      function onInfoFailure(error) {
        console.error('Gagal memuat informasi:', error);
        document.getElementById('infoContainer').innerHTML = '';
        document.getElementById('pinnedContainer').innerHTML = '';
        document.getElementById('quicklinkContainer').innerHTML = '';
      }
      function toggleUserType(e) {
        e.preventDefault();
        const target = e.target.closest('.toggle-btn');
        if (!target || target.classList.contains('active')) return;
        currentUserType = (target.id === 'toggleToInternal') ? 'Internal' : 'Umum';
        const allToggles = document.querySelectorAll('#userTypeToggleContainer .toggle-btn');
        allToggles.forEach(btn => {
          btn.classList.remove('active');
          btn.classList.add('text-gray-500');
        });
        target.classList.add('active');
        target.classList.remove('text-gray-500');
        renderLayananByFilter(currentUserType);
      }
      function renderLayananByFilter(filterType) {
        layananTabsContainer.innerHTML = '';
        layananContentContainer.innerHTML = '';
        const filteredData = semuaLayanan.filter(layanan => {
            const sebagai = (getValueCaseInsensitive(layanan, 'sebagai') || '').toLowerCase();
            const jenis = (getValueCaseInsensitive(layanan, 'jenis') || '').toLowerCase();
            if (jenis === 'setting') return false;
            return filterType === 'Internal' ? sebagai === 'internal' : sebagai !== 'internal';
        });
        if (filteredData.length === 0) {
            layananContentContainer.innerHTML = `<div class="text-center py-10"><p class="text-gray-500">Tidak ada layanan yang tersedia untuk kategori ini.</p></div>`;
            return;
        }
        const groupedLayananData = filteredData.reduce((acc, layanan) => {
            const kategori = getValueCaseInsensitive(layanan, 'Kategori') || 'Lainnya';
            if (!acc[kategori]) acc[kategori] = [];
            acc[kategori].push(layanan);
            return acc;
        }, {});
        const categories = Object.keys(groupedLayananData);
        const colorPalette = [{ bg: 'bg-blue-100', text: 'text-blue-800' }, { bg: 'bg-orange-100', text: 'text-orange-800' }, { bg: 'bg-purple-100', text: 'text-purple-800' }, { bg: 'bg-green-100', text: 'text-green-800' }, { bg: 'bg-red-100', text: 'text-red-800' }, { bg: 'bg-indigo-100', text: 'text-indigo-800' }];
        categories.forEach((kategori, index) => {
            const tabSlide = document.createElement('div');
            tabSlide.className = 'swiper-slide';
            tabSlide.innerHTML = `<button class="layanan-tab" data-category="${kategori}">${kategori}</button>`;
            layananTabsContainer.appendChild(tabSlide);
            const contentPanel = document.createElement('div');
            contentPanel.id = `panel-${kategori}`;
            contentPanel.className = 'layanan-content-panel';
            const categoryCard = document.createElement('div');
            categoryCard.className = "bg-white/50 backdrop-blur-lg p-6 rounded-xl shadow-lg border border-white/30";
            const iconsGrid = document.createElement('div');
            iconsGrid.className = "grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 text-center";
            groupedLayananData[kategori].forEach((layanan, i) => {
                const jenisLayanan = (getValueCaseInsensitive(layanan, 'jenis') || '').toLowerCase();
                const linkUrl = getValueCaseInsensitive(layanan, 'link');
                const colors = colorPalette[i % colorPalette.length];
                const serviceItem = document.createElement(jenisLayanan === 'link' && linkUrl ? 'a' : 'div');
                serviceItem.className = "flex flex-col items-center space-y-2 cursor-pointer group";
                if (jenisLayanan === 'link' && linkUrl) {
                    serviceItem.href = linkUrl;
                    serviceItem.target = '_blank';
                    serviceItem.rel = 'noopener noreferrer';
                }
                serviceItem.innerHTML = `
                    <div class="${colors.bg} ${colors.text} w-16 h-16 rounded-xl flex items-center justify-center text-2xl transition-transform group-hover:scale-110">
                        <i class="fas fa-${getIconForLayanan(layanan)}"></i>
                    </div>
                    <h3 class="font-medium text-xs text-gray-700">${getValueCaseInsensitive(layanan, 'jenis layanan')}</h3>`;
                if (jenisLayanan !== 'link') {
                    Object.assign(serviceItem.dataset, {
                        formFields: getValueCaseInsensitive(layanan, 'form') || '',
                        layananName: getValueCaseInsensitive(layanan, 'jenis layanan') || '',
                        pengolah: getValueCaseInsensitive(layanan, 'pengolah') || '',
                        jenis: getValueCaseInsensitive(layanan, 'jenis') || '',
                        sheet: getValueCaseInsensitive(layanan, 'sheet') || '',
                        sheetId: getValueCaseInsensitive(layanan, 'Sheet ID') || ''
                    });
                    if (serviceItem.dataset.jenis.toLowerCase() === 'kalender') {
                        serviceItem.addEventListener('click', openCalendarModal);
                    } else {
                        serviceItem.addEventListener('click', openFormModal);
                    }
                }
                iconsGrid.appendChild(serviceItem);
            });
            categoryCard.appendChild(iconsGrid);
            contentPanel.appendChild(categoryCard);
            layananContentContainer.appendChild(contentPanel);
            if (index === 0) {
                tabSlide.querySelector('button').classList.add('active');
            } else {
                contentPanel.classList.add('hidden');
            }
        });
        const tabSwiper = new Swiper('.layanan-tabs-swiper', {
            slidesPerView: 'auto',
            spaceBetween: 16,
            freeMode: true,
        });
        layananTabsContainer.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('layanan-tab')) {
                const category = e.target.dataset.category;
                layananTabsContainer.querySelectorAll('.layanan-tab').forEach(tab => tab.classList.remove('active'));
                e.target.classList.add('active');
                layananContentContainer.querySelectorAll('.layanan-content-panel').forEach(panel => {
                    panel.classList.toggle('hidden', panel.id !== `panel-${category}`);
                });
            }
        });
      }
      function renderQuickServicesModal() {
        const container = document.getElementById('quickServicesContainer');
        if (!container || semuaLayanan.length === 0) return;
        container.innerHTML = '';
        const layananTampil = semuaLayanan.filter(layanan => (getValueCaseInsensitive(layanan, 'jenis') || '').toLowerCase() !== 'setting');
        const groupedData = layananTampil.reduce((acc, layanan) => {
          const kategori = getValueCaseInsensitive(layanan, 'Kategori') || 'Lainnya';
          if (!acc[kategori]) acc[kategori] = [];
          acc[kategori].push(layanan);
          return acc;
        }, {});
        for (const kategori in groupedData) {
            const categoryWrapper = document.createElement('div');
            categoryWrapper.className = 'mb-4';
            categoryWrapper.innerHTML = `<h3 class="text-lg font-semibold mb-2 text-brand-green">${kategori}</h3>`;
            const list = document.createElement('ul');
            list.className = 'space-y-2';
            groupedData[kategori].forEach(layanan => {
                const listItem = document.createElement('li');
                const button = document.createElement('button');
                button.className = 'w-full text-left p-2 rounded-lg hover:bg-gray-100';
                button.textContent = getValueCaseInsensitive(layanan, 'jenis layanan');
                Object.assign(button.dataset, {
                  formFields: getValueCaseInsensitive(layanan, 'form') || '',
                  layananName: getValueCaseInsensitive(layanan, 'jenis layanan') || '',
                  pengolah: getValueCaseInsensitive(layanan, 'pengolah') || '',
                  jenis: getValueCaseInsensitive(layanan, 'jenis') || '',
                  sheet: getValueCaseInsensitive(layanan, 'sheet') || '',
                  sheetId: getValueCaseInsensitive(layanan, 'Sheet ID') || ''
                });
                button.addEventListener('click', (e) => {
                    quickServicesModal.classList.add('hidden');
                    const serviceType = e.currentTarget.dataset.jenis.toLowerCase();
                    if (serviceType === 'kalender') {
                        openCalendarModal({ currentTarget: e.currentTarget });
                    } else if (serviceType === 'link') {
                        const linkUrl = getValueCaseInsensitive(layanan, 'link');
                        if (linkUrl) window.open(linkUrl, '_blank');
                    } else {
                        openFormModal({ currentTarget: e.currentTarget });
                    }
                });
                listItem.appendChild(button);
                list.appendChild(listItem);
            });
            categoryWrapper.appendChild(list);
            container.appendChild(categoryWrapper);
        }
      }
      function renderInfoSlider(data) {
        const infoSlider = document.querySelector('.info-swiper');
        const infoWrapper = document.getElementById('infoContainer');
        const infoSection = document.getElementById('info-section');
        infoWrapper.innerHTML = ''; 
        if (!data || data.length === 0) {
          if(infoSection) infoSection.style.display = 'none';
          return;
        }
        if(infoSection) infoSection.style.display = 'block';
        data.forEach(item => {
          const infoText = getValueCaseInsensitive(item, 'info');
          const gambar = getValueCaseInsensitive(item, 'gambar');
          const link = getValueCaseInsensitive(item, 'link');
          const warna = getValueCaseInsensitive(item, 'warna');
          if (infoText && link) {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide h-auto';
            let cardHtml = '';
            if (gambar) {
              cardHtml = `<a href="${link}" target="_blank" rel="noopener noreferrer" class="block w-full h-full rounded-xl shadow-sm hover:shadow-md transition-shadow duration-300 overflow-hidden"><img src="${gambar}" alt="${infoText}" class="w-full h-full object-cover aspect-[2.35/1]" onerror="this.parentElement.style.display='none'"/><p class="hidden">${infoText}</p></a>`;
            } else {
              let bgColorStyle = `style="background-color: ${warna || '#10b981'}"`;
              let textColorClass = getTextColorForBg(warna);
              let iconBgStyle = `style="background-color: rgba(0,0,0,0.2)"`;
              cardHtml = `<a href="${link}" target="_blank" rel="noopener noreferrer" class="flex items-start p-3 rounded-xl shadow-sm hover:opacity-90 transition-opacity duration-300 h-full ${textColorClass}" ${bgColorStyle}>
                <div class="rounded-lg p-2.5 mr-3" ${iconBgStyle}>
                  <i class="fas fa-bullhorn text-lg"></i>
                </div>
                <p class="font-medium text-xs">${infoText}</p>
              </a>`;
            }
            slide.innerHTML = cardHtml;
            infoWrapper.appendChild(slide);
          }
        });
        if (infoSlider.swiper) infoSlider.swiper.destroy(true, true);
        const isSliderActive = data.length > 1;
        const swiper = new Swiper('.info-swiper', {
          loop: isSliderActive,
          autoplay: isSliderActive ? { delay: 4000, disableOnInteraction: false } : false,
          slidesPerView: 1,
          spaceBetween: 24,
          grabCursor: true,
          pagination: { el: '.swiper-pagination', clickable: true },
          breakpoints: { 768: { slidesPerView: data.length > 1 ? 2 : 1 } }
        });
        infoSlider.classList.toggle('info-grid', !isSliderActive);
      }
      function renderPinnedButtons(data) {
        const pinnedWrapper = document.getElementById('pinnedContainer');
        const pinnedSection = document.getElementById('pinned-section');
        pinnedWrapper.innerHTML = '';
        if (!data || data.length === 0) {
          if(pinnedSection) pinnedSection.style.display = 'none';
          return;
        }
        if(pinnedSection) pinnedSection.style.display = 'block';
        pinnedWrapper.classList.toggle('md:grid-cols-2', data.length > 1);
        data.forEach(item => {
          const infoText = getValueCaseInsensitive(item, 'info');
          const link = getValueCaseInsensitive(item, 'link');
          const icon = getValueCaseInsensitive(item, 'ikon') || 'link';
          const warna = getValueCaseInsensitive(item, 'warna');
          if (infoText && link) {
            const button = document.createElement('a');
            button.href = link;
            button.target = '_blank';
            button.rel = 'noopener noreferrer';
            let bgColor = warna || '#1a3a3a';
            button.style.backgroundColor = bgColor;
            let textColorClass = getTextColorForBg(bgColor);
            button.className = `flex items-center p-2 rounded-xl shadow-sm hover:opacity-90 transition-opacity duration-300 ${textColorClass}`;
            button.innerHTML = `
              <div class="bg-black bg-opacity-20 rounded-lg p-2 mr-2">
                <i class="fas fa-${icon} text-lg"></i>
              </div>
              <p class="font-medium text-xs">${infoText}</p>
            `;
            pinnedWrapper.appendChild(button);
          }
        });
      }
      function renderQuickLinks(data) {
        const quicklinkWrapper = document.getElementById('quicklinkContainer');
        const quicklinkSection = document.getElementById('quicklink-section');
        quicklinkWrapper.innerHTML = '';
        if (!data || data.length === 0) {
            if (quicklinkSection) quicklinkSection.style.display = 'none';
            return;
        }
        if (quicklinkSection) quicklinkSection.style.display = 'block';
        const colorPalette = [
            { bg: 'bg-blue-100', text: 'text-blue-600' },
            { bg: 'bg-green-100', text: 'text-green-600' },
            { bg: 'bg-yellow-100', text: 'text-yellow-600' },
            { bg: 'bg-purple-100', text: 'text-purple-600' },
            { bg: 'bg-pink-100', text: 'text-pink-600' },
            { bg: 'bg-indigo-100', text: 'text-indigo-600' },
            { bg: 'bg-red-100', text: 'text-red-600' },
            { bg: 'bg-orange-100', text: 'text-orange-600' }
        ];
        data.forEach((item, index) => {
            const infoText = getValueCaseInsensitive(item, 'info');
            const link = getValueCaseInsensitive(item, 'link');
            const icon = getValueCaseInsensitive(item, 'icon') || 'external-link-alt';
            const warna = getValueCaseInsensitive(item, 'warna');
            if (infoText && link) {
                const quickLink = document.createElement('a');
                quickLink.href = link;
                quickLink.target = '_blank';
                quickLink.rel = 'noopener noreferrer';
                quickLink.className = 'flex flex-col items-center space-y-2 text-gray-700 hover:opacity-80 transition-opacity';
                let bgColor = '';
                let textColor = '';
                let styleAttr = '';
                if (warna) {
                    styleAttr = `style="background-color:${warna}; color:${getTextColorForBg(warna)}"`;
                } else {
                    const randomColor = colorPalette[index % colorPalette.length];
                    bgColor = randomColor.bg;
                    textColor = randomColor.text;
                }
                quickLink.innerHTML = `
                  <div class="w-12 h-12 rounded-xl flex items-center justify-center text-xl ${bgColor} ${textColor}" ${styleAttr}>
                      <i class="fas fa-${icon}"></i>
                  </div>
                  <p class="text-xs font-medium">${infoText}</p>
                `;
                quicklinkWrapper.appendChild(quickLink);
            }
        });
      }
      function renderFooterLinks(data) {
        const footerWrapper = document.getElementById('footerLinkContainer');
        footerWrapper.innerHTML = '';
        if (!data || data.length === 0) {
          return;
        }
        data.forEach(item => {
            const infoText = getValueCaseInsensitive(item, 'info');
            const link = getValueCaseInsensitive(item, 'link');
            if (infoText && link) {
                const iconClass = getFooterIcon(infoText);
                const footerLink = document.createElement('a');
                footerLink.href = link;
                footerLink.target = '_blank';
                footerLink.rel = 'noopener noreferrer';
                footerLink.className = 'text-gray-500 hover:text-brand-green transition-colors text-xl';
                footerLink.dataset.itemName = infoText;
                footerLink.innerHTML = `<i class="${iconClass}"></i>`;
                footerWrapper.appendChild(footerLink);
            }
        });
      }
      function openFormModal(event) {
        const card = event.currentTarget;
        const { formFields, layananName, pengolah, sheet, sheetId } = card.dataset;
        if (!formFields || !sheet) return;
        modalTitle.textContent = `Formulir ${layananName}`;
        const allFields = formFields.split(',').map(field => field.trim());
        const isPeminjaman = layananName && layananName.toLowerCase().includes('peminjaman');
        const isPengaduan = layananName && layananName.toLowerCase().includes('pengaduan');
        let formHtml = `<input type="hidden" id="pengolah-input" name="Pengolah" value="${pengolah}" />`;
        formHtml += `<input type="hidden" name="Jenis Layanan" value="${layananName}" />`;
        if (isPengaduan) {
          let pelaporHtml = '';
          let terlaporHtml = '';
          let lainnyaHtml = '';
          const satuanKerjaOptions = ['Rektorat', 'Biro AUAK', 'Fakultas Syariah dan Hukum Islam', 'Fakultas Tarbiyah', 'Fakultas Ekonomi dan Bisnis Islam', 'Fakultas Ushuluddin dan Dakwah', 'Pascasarjana', 'Lembaga Penjaminan Mutu', 'Lembaga Penelitian dan Pengabdian Masyarakat', 'Satuan Pengawasan Internal', 'UPT TIPD', 'UPT Perpustakaan', 'UPT Bahasa', 'UPT Mahad Al Jamiah'];
          const jenisAduanOptions = ['Korupsi / Pungli', 'Pelayanan Publik', 'Penyalahgunaan Wewenang', 'Tata Laksana / Regulasi', 'Hukum / HAM', 'Kepegawian', 'Umum'];
          allFields.forEach(field => {
              const fieldId = `form-input-${field.replace(/\s+/g, '-')}`;
              const fieldLower = field.toLowerCase();
              let isRequired = !['email', 'telepon', 'anonim', 'rahasia', 'file'].includes(fieldLower.replace(/ identitas pelapor| pelapor/g, ''));
              let fieldInputHtml = '';
              let wrapperClass = 'mb-4';
              if (fieldLower.includes('anonim')) {
                  fieldInputHtml = `<div class="flex items-center mt-2"><input type="checkbox" id="${fieldId}" name="${field}" class="h-4 w-4 text-green-800 border-gray-300 rounded focus:ring-green-800" /><label for="${fieldId}" class="ml-2 text-sm text-gray-600">Saya ingin identitas saya sebagai ANONIM, yang tidak dapat dilihat oleh Terlapor dan publik</label></div>`;
                  wrapperClass = 'md:col-span-2';
              } else if (fieldLower.includes('rahasia')) {
                  fieldInputHtml = `<div class="flex items-center mt-2"><input type="checkbox" id="${fieldId}" name="${field}" class="h-4 w-4 text-green-800 border-gray-300 rounded focus:ring-green-800" /><label for="${fieldId}" class="ml-2 text-sm text-gray-600">Saya ingin Isi Laporan Saya menjadi Rahasia oleh Publik</label></div>`;
                  wrapperClass = 'md:col-span-2';
              } else {
                  let inputElement = '';
                    if (fieldLower.includes('jenis kelamin')) {
                      inputElement = `<select id="${fieldId}" name="${field}" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white text-sm" required="required"><option value="" disabled="disabled" selected="selected">-- Pilih --</option><option>Laki-laki</option><option>Perempuan</option></select>`;
                  } else if (fieldLower.includes('email')) {
                      inputElement = `<input type="email" id="${fieldId}" name="${field}" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />`;
                  } else if (fieldLower.includes('telepon')) {
                      inputElement = `<input type="number" id="${fieldId}" name="${field}" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />`;
                  } else if (fieldLower.includes('jenis identitas')) {
                      inputElement = `<select id="${fieldId}" name="${field}" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white text-sm" required="required"><option value="" disabled="disabled" selected="selected">-- Pilih --</option><option>KTP</option><option>Visa</option><option>SIM</option></select>`;
                  } else if (fieldLower.includes('satuan kerja') || fieldLower.includes('unit kerja')) {
                      const optionsHtml = satuanKerjaOptions.map(opt => `<option>${opt}</option>`).join('');
                      inputElement = `<select id="${fieldId}" name="${field}" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white text-sm" required="required"><option value="" disabled="disabled" selected="selected">-- Pilih Satuan Kerja --</option>${optionsHtml}</select>`;
                  } else if (fieldLower === 'jenis') {
                      const optionsHtml = jenisAduanOptions.map(opt => `<option>${opt}</option>`).join('');
                      inputElement = `<select id="${fieldId}" name="${field}" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white text-sm" required="required"><option value="" disabled="disabled" selected="selected">-- Pilih Jenis Aduan --</option>${optionsHtml}</select>`;
                  } else if (fieldLower.includes('isi laporan') || fieldLower.includes('harapan') || fieldLower.includes('topik')) {
                      inputElement = `<textarea id="${fieldId}" name="${field}" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" ${isRequired ? 'required="required"' : ''}></textarea>`;
                      wrapperClass += ' md:col-span-2';
                  } else if (fieldLower.includes('file')) {
                      inputElement = `<input type="file" id="${fieldId}" name="${field}" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100" />`;
                      wrapperClass += ' md:col-span-2';
                  } else {
                      inputElement = `<input type="text" id="${fieldId}" name="${field}" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" ${isRequired ? 'required="required"' : ''} />`;
                  }
                  fieldInputHtml = `<label for="${fieldId}" class="block text-sm font-medium text-gray-700 mb-1">${field}</label>${inputElement}`;
              }
              const fieldWrapperHtml = `<div class="${wrapperClass}">${fieldInputHtml}</div>`;
              if (fieldLower.includes('pelapor')) {
                  pelaporHtml += fieldWrapperHtml;
              } else if (fieldLower.includes('terlapor')) {
                  terlaporHtml += fieldWrapperHtml;
              } else {
                  lainnyaHtml += fieldWrapperHtml;
              }
          });
          formHtml += `
              <div class="mb-4">
                  <label class="flex items-center cursor-pointer">
                      <input type="checkbox" id="lapor-terlapor-checkbox" class="h-4 w-4 text-green-800 border-gray-300 rounded focus:ring-green-800" />
                      <span class="ml-3 text-sm font-medium text-gray-800">Saya ingin melaporkan Terlapor</span>
                  </label>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                  <div>
                      <h3 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">Informasi Pelapor</h3>
                      ${pelaporHtml}
                  </div>
                  <div id="terlapor-section">
                      <h3 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">Informasi Terlapor</h3>
                      ${terlaporHtml}
                  </div>
              </div>
              <div class="mt-4">
                  <h3 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">Informasi Lainnya</h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                      ${lainnyaHtml}
                  </div>
              </div>
          `;
        } else { 
            let fieldsContainerHtml = '';
            if (isPeminjaman) {
              const unitKerjaOptions = ['Rektorat', 'Fakultas Syariah dan Hukum Islam', 'Fakultas Tarbiyah', 'Fakultas Ekonomi dan Bisnis Islam', 'Fakultas Ushuluddin dan Dakwah', 'Pascasarjana'];
              let optionsHtml = unitKerjaOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('');
              fieldsContainerHtml += `
                <div class="mb-4 md:col-span-2">
                  <label for="unit-kerja-layanan" class="block text-sm font-medium text-gray-700 mb-1">Unit Kerja Layanan</label>
                  <select id="unit-kerja-layanan" name="Unit Kerja Layanan" required="required" class="w-full px-4 py-2 border border-yellow-300 rounded-lg bg-yellow-50 text-sm focus:ring-yellow-400 focus:border-yellow-400">
                    <option value="" disabled="disabled" selected="selected">-- Pilih Unit Kerja --</option>
                    ${optionsHtml}
                  </select>
                </div>
              `;
              fieldsContainerHtml += `
                <div class="mb-4 md:col-span-2">
                  <label for="jenis-layanan-peminjaman" class="block text-sm font-medium text-gray-700 mb-1">Jenis Layanan</label>
                  <select id="jenis-layanan-peminjaman" name="Jenis Layanan" required="required" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white text-sm">
                      <option value="" disabled="disabled" selected="selected">-- Pilih --</option>
                      <option>Peminjaman Tempat</option>
                      <option>Peminjaman Kendaraan</option>
                  </select>
                </div>
              `;
            }
            allFields.forEach(field => {
                if (isPeminjaman && field.toLowerCase().trim() === 'jenis layanan') {
                    return;
                }
                const fieldId = field.replace(/\s+/g, '-');
                const fieldLower = field.toLowerCase().trim();
                let description = '';
                const descriptions = {
                    'nama': 'Nama Organisasi atau Individu',
                    'perihal': 'Contoh: Permohonan Peminjaman Aula Utama / Bus',
                    'kegiatan': 'Contoh: FESTASI III Biru 17 Kampus V UNM Parepare di Pare Pare',
                    'email': 'Silakan mengisi Email atau Telepon untuk memudahkan penyampaian informasi pelayanan.',
                    'telepon': 'Silakan mengisi Email atau Telepon untuk memudahkan penyampaian informasi pelayanan.'
                };
                if (descriptions[fieldLower]) {
                    description = `<p class="text-xs text-gray-500 mt-1">${descriptions[fieldLower]}</p>`;
                }
                const isRequired = !['email', 'telepon'].includes(fieldLower);
                const inputType = (fieldLower.includes('tanggal') || fieldLower.includes('tgl')) ? 'date' : 'text';
                fieldsContainerHtml += `
                    <div class="mb-4">
                        <label for="${fieldId}" class="block text-sm font-medium text-gray-700 mb-1">${field}</label>
                        <input type="${inputType}" id="${fieldId}" name="${field}" ${isRequired ? 'required="required"' : ''} class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                        ${description}
                    </div>
                `;
            });
            formHtml += `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-4">${fieldsContainerHtml}</div>`;
        }
        permohonanForm.innerHTML = formHtml;
        permohonanForm.dataset.targetSheet = sheet;
        permohonanForm.dataset.targetSheetId = sheetId;
        if (isPengaduan) {
            const laporCheckbox = document.getElementById('lapor-terlapor-checkbox');
            const terlaporSection = document.getElementById('terlapor-section');
            if (laporCheckbox && terlaporSection) {
                const terlaporInputs = terlaporSection.querySelectorAll('input, select, textarea');
                const updateTerlaporState = (shouldBeEnabled) => {
                    terlaporSection.classList.toggle('section-disabled', !shouldBeEnabled);
                    terlaporInputs.forEach(input => {
                        input.disabled = !shouldBeEnabled;
                        const inputName = input.name.toLowerCase();
                        if (!inputName.includes('anonim') && !inputName.includes('rahasia')) {
                          input.required = shouldBeEnabled;
                        }
                    });
                };
                updateTerlaporState(false);
                laporCheckbox.addEventListener('change', (e) => {
                    updateTerlaporState(e.target.checked);
                });
            }
        }
        formModal.classList.remove('hidden');
      }
      function handlePermohonanSubmit(e) {
        e.preventDefault();
        const { targetSheet, targetSheetId } = e.target.dataset;
        const submitBtn = document.getElementById('submitPermohonanBtn');
        if (!targetSheet) {
          showNotificationModal('Error', 'Tujuan penyimpanan data tidak ditemukan.', 'error');
          return;
        }
        const formData = new FormData(e.target);
        const dataObject = Object.fromEntries(formData.entries());
        submitBtn.textContent = 'Mengirim...';
        submitBtn.disabled = true;
        const fileInput = e.target.querySelector('input[type="file"][name="File"]');
        const file = fileInput ? fileInput.files[0] : null;
        const runServerCall = (fileData = null) => {
            if (fileData) dataObject.fileData = fileData;
            delete dataObject.File;
            fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({
                    action: 'submitPermohonan',
                    formData: dataObject,
                    sheetName: targetSheet,
                    sheetId: targetSheetId
                })
            })
            .then(res => res.json())
            .then(onPermohonanSuccess)
            .catch(onPermohonanFailure);
        };
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result.split(',')[1];
                const fileData = {
                    base64Data: base64Data,
                    name: file.name,
                    type: file.type
                };
                runServerCall(fileData);
            };
            reader.onerror = function() {
                showNotificationModal('Error', 'Gagal membaca file lampiran.', 'error');
                submitBtn.textContent = 'Kirim';
                submitBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        } else {
            runServerCall();
        }
      }
      function handleHelpdeskSubmit(e) {
          e.preventDefault();
          const btn = document.getElementById('submitHelpdeskBtn');
          btn.textContent = 'Mengirim...';
          btn.disabled = true;
          const formData = new FormData(e.target);
          const dataObject = Object.fromEntries(formData.entries());
          fetch(GAS_WEB_APP_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              body: JSON.stringify({
                  action: 'submitHelpdesk',
                  formData: dataObject
              })
          })
          .then(res => res.json())
          .then(response => {
              helpdeskModal.classList.add('hidden');
              if (response.success) {
                  showNotificationModal('Berhasil', 'Pesan Anda telah terkirim. Terima kasih.', 'success');
                  helpdeskForm.reset();
              } else {
                  showNotificationModal('Gagal', `Gagal mengirim pesan: ${response.message}`, 'error');
              }
              btn.textContent = 'Kirim';
              btn.disabled = false;
          })
          .catch(err => {
              showNotificationModal('Error', 'Terjadi kesalahan saat mengirim pesan.', 'error');
              console.error(err);
              btn.textContent = 'Kirim';
              btn.disabled = false;
          });
      }
      function onPermohonanSuccess(response) {
        formModal.classList.add('hidden');
        if (response.success) {
          if (response.id) {
            showNotificationModal('Berhasil!', `Permohonan Anda telah dikirim. Gunakan ID ini untuk melacak: <strong class="text-lg">${response.id}</strong>`, 'success');
          } else {
            showNotificationModal('Berhasil!', 'Permohonan Anda telah terkirim, namun ID pelacakan tidak dapat dibuat. Silakan hubungi admin.', 'success');
          }
        } else {
          showNotificationModal('Gagal', `Gagal mengirim permohonan: ${response.message || 'Terjadi kesalahan yang tidak diketahui.'}`, 'error');
        }
        document.getElementById('submitPermohonanBtn').textContent = 'Kirim';
        document.getElementById('submitPermohonanBtn').disabled = false;
      }
      function onPermohonanFailure(error) {
        showNotificationModal('Error', 'Terjadi kesalahan saat mengirim permohonan.', 'error');
        console.error('Submit Gagal:', error);
        document.getElementById('submitPermohonanBtn').textContent = 'Kirim';
        document.getElementById('submitPermohonanBtn').disabled = false;
      }
    
      // PERUBAHAN 4: Modifikasi fungsi openCalendarModal untuk menggunakan cache
      function openCalendarModal(event) {
        const { sheet, sheetId } = event.currentTarget.dataset;
        if (!sheet) {
          showNotificationModal('Error Konfigurasi', 'Sheet untuk kalender belum diatur.', 'error');
          return;
        }
        calendarModal.classList.remove('hidden');
        const isMobile = window.innerWidth < 768;
        const cacheKey = `${sheet}-${sheetId}`;

        const eventSource = (fetchInfo, successCallback, failureCallback) => {
            // Cek apakah data sudah ada di cache
            if (calendarDataCache[cacheKey]) {
                console.log(`Loading calendar events from cache for: ${sheet}`);
                successCallback(calendarDataCache[cacheKey]);
                return;
            }

            // Jika tidak ada di cache, fetch seperti biasa
            console.log(`Fetching calendar events from network for: ${sheet}`);
            fetch(`${GAS_WEB_APP_URL}?action=getCalendarEvents&sheetName=${encodeURIComponent(sheet)}&sheetId=${encodeURIComponent(sheetId)}`)
            .then(res => res.json())
            .then(events => {
                const validEvents = Array.isArray(events) ? events : [];
                // Simpan ke cache untuk penggunaan selanjutnya
                calendarDataCache[cacheKey] = validEvents;
                successCallback(validEvents);
            })
            .catch(failureCallback);
        };
        
        if (!calendar) {
          calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'id',
            initialView: isMobile ? 'listWeek' : 'dayGridMonth',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listWeek' },
            noEventsContent: 'Tidak ada jadwal peminjaman pada periode ini.',
            events: eventSource,
            height: '100%',
            eventClick: (info) => {
              const props = info.event.extendedProps;
              let detailsHtml = Object.entries(props)
                .filter(([key]) => key !== 'iconName')
                .map(([key, value]) => `<dt class="font-semibold">${key}</dt><dd class="mb-2">${value || '-'}</dd>`)
                .join('');
              showNotificationModal('Detail Peminjaman', `<dl class="text-left">${detailsHtml}</dl>`, 'custom');
            },
            eventContent: (arg) => ({ html: `<i class="fas fa-${arg.event.extendedProps.iconName || 'calendar-alt'} mr-2"></i>${arg.event.title}` }),
            loading: (isLoading) => calendarLoader.style.display = isLoading ? 'flex' : 'none',
          });
          calendar.render();
        } else {
            calendar.getEventSources().forEach(source => source.remove());
            calendar.addEventSource(eventSource);
            calendar.refetchEvents();
        }
      }

      function handleTracking(e) {
        e.preventDefault();
        setTrackingLoading(true, 'trackButton');
        trackingResult.innerHTML = '';
        const permohonanId = document.getElementById('permohonanId').value;
        const selectedOption = trackingLayananSelect.value;
        if(!selectedOption) {
            onTrackSuccess({ error: 'Silakan pilih jenis layanan.' });
            return;
        }
        const { name: sheetName, id: sheetId } = JSON.parse(selectedOption);
        const url = `${GAS_WEB_APP_URL}?action=trackPermohonan&permohonanId=${encodeURIComponent(permohonanId)}&sheetName=${encodeURIComponent(sheetName)}&sheetId=${encodeURIComponent(sheetId)}`;
        fetch(url)
            .then(res => res.json())
            .then(onTrackSuccess)
            .catch(onTrackFailure);
      }
      function handleMobileTracking(e) {
          e.preventDefault();
          setTrackingLoading(true, 'mobileTrackButton');
          const resultContainer = document.getElementById('mobileTrackingResult');
          resultContainer.innerHTML = '';
          const permohonanId = document.getElementById('mobilePermohonanId').value;
          const selectedOption = document.getElementById('mobileTrackingLayananSelect').value;
          if(!selectedOption) {
            onTrackSuccess({ error: 'Silakan pilih jenis layanan.' }, 'mobile');
            return;
          }
          const { name: sheetName, id: sheetId } = JSON.parse(selectedOption);
          const url = `${GAS_WEB_APP_URL}?action=trackPermohonan&permohonanId=${encodeURIComponent(permohonanId)}&sheetName=${encodeURIComponent(sheetName)}&sheetId=${encodeURIComponent(sheetId)}`;
          fetch(url)
              .then(res => res.json())
              .then(result => onTrackSuccess(result, 'mobile'))
              .catch(err => onTrackFailure(err, 'mobile'));
      }
      function onTrackSuccess(result, view = 'desktop') {
        setTrackingLoading(false, view === 'desktop' ? 'trackButton' : 'mobileTrackButton');
        const resultContainer = view === 'desktop' ? trackingResult : document.getElementById('mobileTrackingResult');
        let content = '';
        if (result && result.error) {
          content = `<div class="p-4 bg-red-100 text-red-700 rounded-lg relative">${result.error}</div>`;
        } else if (result) {
            const isAnonim = (getValueCaseInsensitive(result, 'anonim') === 'on' || getValueCaseInsensitive(result, 'anonim') === true);
            const fieldsToHide = ['Nama Pelapor', 'Email Identitas Pelapor', 'Telepon Identitas Pelapor', 'No Identitas Pelapor'];
            if(isAnonim){
                fieldsToHide.forEach(field => {
                    if(result[field]) result[field] = '*****';
                });
            }
          const status = getValueCaseInsensitive(result, 'status') || 'N/A';
          const idPermohonan = getValueCaseInsensitive(result, 'idpermohonan') || getValueCaseInsensitive(result, 'idlayanan') || 'N/A';
          const statusClasses = { disetujui: 'bg-green-100 text-green-800', diajukan: 'bg-yellow-100 text-yellow-800', ditahan: 'bg-orange-100 text-orange-800', selesai: 'bg-blue-100 text-blue-800', ditolak: 'bg-red-100 text-red-700' };
          const bgColorClass = statusClasses[status.toLowerCase()] || 'bg-gray-100 text-gray-800';
          let detailsHtml = Object.entries(result)
            .filter(([key, value]) => !['idpermohonan', 'idlayanan', 'status'].includes(key.toLowerCase()) && value)
            .map(([key, value]) => `<div class="flex flex-col"><dt class="text-sm font-medium text-gray-500">${key}</dt><dd class="text-sm">${value}</dd></div>`)
            .join('');
          content = `
            <div class="p-4 ${bgColorClass} rounded-lg relative">
              <p class="font-semibold">Status untuk ID: ${idPermohonan}</p>
              <p class="text-2xl font-bold">${status}</p>
              <dl class="mt-4 border-t border-gray-200 pt-4 grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">${detailsHtml}</dl>
            </div>`;
        } else {
          content = `<div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg relative">ID Permohonan tidak ditemukan.</div>`;
        }
        resultContainer.innerHTML = content.replace('</div>', '<button class="js-close-track-result absolute top-2 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&#215;</button></div>');
      }
      function onTrackFailure(error, view = 'desktop') {
        setTrackingLoading(false, view === 'desktop' ? 'trackButton' : 'mobileTrackButton');
        const resultContainer = view === 'desktop' ? trackingResult : document.getElementById('mobileTrackingResult');
        console.error('Gagal melacak:', error);
        resultContainer.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg relative">Terjadi kesalahan. <button class="js-close-track-result absolute top-2 right-3">&#215;</button></div>`;
      }
      function setTrackingLoading(isLoading, buttonId) {
        const button = document.getElementById(buttonId);
        if (!button) return;
        const icon = button.querySelector('i');
        const spinner = button.querySelector('div');
        if (isLoading) {
            if(icon) icon.style.display = 'none';
            if(spinner) spinner.style.display = 'inline-block';
            button.disabled = true;
        } else {
            if(icon) icon.style.display = 'inline-block';
            if(spinner) spinner.style.display = 'none';
            button.disabled = false;
        }
      }
    });
    // ]]>
    </script>
  </body>
</html>
